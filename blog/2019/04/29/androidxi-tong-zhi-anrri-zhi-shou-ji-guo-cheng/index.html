
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Android系统之ANR日志收集过程-Java层 - Lapisy的博客</title>
  <meta name="author" content="Lapisy">

  
  <meta name="description" content="文章所有的源码都是基于SDK-28的版本，也就是Android P的版本 一：概述 我们在解决ANR异常时，一般是利用打印出来的anr log，还有就是发生ANR的栈信息。一般情况下解决ANR步骤为： &#8195;1. 先利用main log来查看ANR发生的原因， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.lapisy.com/blog/2019/04/29/androidxi-tong-zhi-anrri-zhi-shou-ji-guo-cheng/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Lapisy的博客" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> -->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lapisy的博客</a></h1>
  
    <h2>Learning and Thinking</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="laisy的博客邮箱" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.lapisy.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">归档</a></li>
  <li><a href="/reading/index.html">读书</a></li>
  <!-- <li><a href="/about">关于</a></li> -->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Android系统之ANR日志收集过程-Java层</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-29T22:24:59+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>10:24 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p>文章所有的源码都是基于SDK-28的版本，也就是Android P的版本</p></blockquote>

<h3>一：概述</h3>

<p>我们在解决ANR异常时，一般是利用打印出来的anr log，还有就是发生ANR的栈信息。一般情况下解决ANR步骤为：</p>

<p>&#8195;1. 先利用main log来查看ANR发生的原因，是DispatchTimeout还是BroadcastTimeout，还是ServiceTimeout。同时也可以看发生ANA之前或者之后的各个进程CPU的使用情况。其基本的格式如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">08</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">46.009</span> <span class="mi">1638</span><span class="o">-</span><span class="mi">1668</span><span class="o">/</span><span class="n">system_process</span> <span class="n">E</span><span class="o">/</span><span class="nl">ActivityManager:</span> <span class="n">ANR</span> <span class="n">in</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">lapisy</span><span class="o">.</span><span class="na">apptemplate</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">lapisy</span><span class="o">.</span><span class="na">apptemplate</span><span class="o">/.</span><span class="na">MainActivity</span><span class="o">)</span>
</span><span class='line'>    <span class="nl">PID:</span> <span class="mi">23720</span>
</span><span class='line'>    <span class="nl">Reason:</span> <span class="n">Input</span> <span class="n">dispatching</span> <span class="n">timed</span> <span class="nf">out</span> <span class="o">(</span><span class="n">Waiting</span> <span class="n">to</span> <span class="n">send</span> <span class="n">non</span><span class="o">-</span><span class="n">key</span> <span class="n">event</span> <span class="n">because</span> <span class="n">the</span> <span class="n">touched</span> <span class="n">window</span> <span class="n">has</span> <span class="n">not</span> <span class="n">finished</span> <span class="n">processing</span> <span class="n">certain</span> <span class="n">input</span> <span class="n">events</span> <span class="n">that</span> <span class="n">were</span> <span class="n">delivered</span> <span class="n">to</span> <span class="n">it</span> <span class="n">over</span> <span class="mf">500.0</span><span class="n">ms</span> <span class="n">ago</span><span class="o">.</span>  <span class="n">Wait</span> <span class="n">queue</span> <span class="nl">length:</span> <span class="mi">6</span><span class="o">.</span>  <span class="n">Wait</span> <span class="n">queue</span> <span class="n">head</span> <span class="nl">age:</span> <span class="mf">5533.6</span><span class="n">ms</span><span class="o">.)</span>
</span><span class='line'>    <span class="nl">Load:</span> <span class="mf">0.89</span> <span class="o">/</span> <span class="mf">0.44</span> <span class="o">/</span> <span class="mf">0.34</span>
</span><span class='line'>    <span class="n">CPU</span> <span class="n">usage</span> <span class="n">from</span> <span class="mi">839843</span><span class="n">ms</span> <span class="n">to</span> <span class="mi">0</span><span class="n">ms</span> <span class="nf">ago</span> <span class="o">(</span><span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">18</span> <span class="mi">18</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mf">53.827</span> <span class="n">to</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">08</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">44.991</span><span class="o">):</span>
</span><span class='line'>      <span class="mf">4.5</span><span class="o">%</span> <span class="mi">1638</span><span class="o">/</span><span class="nl">system_server:</span> <span class="mi">3</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">1.4</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">22176</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">2.2</span><span class="o">%</span> <span class="mi">1387</span><span class="o">/</span><span class="nl">adbd:</span> <span class="mf">0.2</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">2</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">49043</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.8</span><span class="o">%</span> <span class="mi">1401</span><span class="o">/</span><span class="n">android</span><span class="o">.</span><span class="na">hardware</span><span class="o">.</span><span class="na">graphics</span><span class="o">.</span><span class="na">composer</span><span class="err">@</span><span class="mf">2.1</span><span class="o">-</span><span class="nl">service:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.7</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">18</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.4</span><span class="o">%</span> <span class="mi">1395</span><span class="o">/</span><span class="n">android</span><span class="o">.</span><span class="na">hardware</span><span class="o">.</span><span class="na">audio</span><span class="err">@</span><span class="mf">2.0</span><span class="o">-</span><span class="nl">service:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.4</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">3</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.4</span><span class="o">%</span> <span class="mi">1491</span><span class="o">/</span><span class="nl">audioserver:</span> <span class="mf">0.1</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">7</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.4</span><span class="o">%</span> <span class="mi">1413</span><span class="o">/</span><span class="nl">surfaceflinger:</span> <span class="mf">0.1</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">49</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.2</span><span class="o">%</span> <span class="mi">1780</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">systemui</span><span class="o">:</span> <span class="mf">0.1</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">1488</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.1</span><span class="o">%</span> <span class="mi">1868</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">phone</span><span class="o">:</span> <span class="mf">0.1</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">1056</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.1</span><span class="o">%</span> <span class="mi">1335</span><span class="o">/</span><span class="nl">logd:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">47</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.1</span><span class="o">%</span> <span class="mi">2223</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">launcher3</span><span class="o">:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">2852</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.1</span><span class="o">%</span> <span class="mi">7</span><span class="o">/</span><span class="nl">rcu_preempt:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>      <span class="o">.....</span>
</span><span class='line'><span class="n">CPU</span> <span class="n">usage</span> <span class="n">from</span> <span class="mi">79</span><span class="n">ms</span> <span class="n">to</span> <span class="mi">620</span><span class="n">ms</span> <span class="nf">later</span> <span class="o">(</span><span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mf">21.096</span> <span class="n">to</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mf">21.637</span><span class="o">):</span>
</span><span class='line'>      <span class="mi">159</span><span class="o">%</span> <span class="mi">8892</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">huawei</span><span class="o">.</span><span class="na">systemmanager</span><span class="o">:</span> <span class="mi">146</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">13</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">751</span> <span class="n">minor</span> <span class="mi">2</span> <span class="n">major</span>
</span><span class='line'>        <span class="mi">92</span><span class="o">%</span> <span class="mi">9393</span><span class="o">/</span><span class="n">pool</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">2</span><span class="o">:</span> <span class="mi">92</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>        <span class="mi">16</span><span class="o">%</span> <span class="mi">9436</span><span class="o">/</span><span class="nl">refresh_permiss:</span> <span class="mi">13</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">2.7</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>        <span class="mf">8.1</span><span class="o">%</span> <span class="mi">8902</span><span class="o">/</span><span class="nl">HeapTaskDaemon:</span> <span class="mf">8.1</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>        <span class="mf">2.7</span><span class="o">%</span> <span class="mi">9428</span><span class="o">/</span><span class="nl">PermissionAppsC:</span> <span class="mf">2.7</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>       <span class="o">+</span><span class="mi">0</span><span class="o">%</span> <span class="mi">9453</span><span class="o">/</span><span class="n">pool</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>       <span class="o">+</span><span class="mi">0</span><span class="o">%</span> <span class="mi">9457</span><span class="o">/</span><span class="n">pool</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">0</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>      <span class="mi">99</span><span class="o">%</span> <span class="mi">1279</span><span class="o">/</span><span class="nl">system_server:</span> <span class="mi">45</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">53</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">1350</span> <span class="n">minor</span>
</span><span class='line'>        <span class="mi">49</span><span class="o">%</span> <span class="mi">1327</span><span class="o">/</span><span class="nl">ActivityManager:</span> <span class="mi">12</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">37</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>        <span class="mi">14</span><span class="o">%</span> <span class="mi">1900</span><span class="o">/</span><span class="nl">Binder:</span><span class="mi">1279_7</span><span class="o">:</span> <span class="mi">10</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">4.1</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>        <span class="mi">12</span><span class="o">%</span> <span class="mi">11218</span><span class="o">/</span><span class="nl">Binder:</span><span class="mi">1279_19</span><span class="o">:</span> <span class="mi">10</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">2</span><span class="o">%</span> <span class="n">kernel</span>
</span><span class='line'>       <span class="o">......</span>
</span><span class='line'>    <span class="mi">47</span><span class="o">%</span> <span class="nl">TOTAL:</span> <span class="mi">31</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">15</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">%</span> <span class="n">softirq</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<p>&#8195;2. 然后利用traces文件中具体的栈信息，来判断具体的位置和具体的原因。其基本格式和日志如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">-----</span> <span class="n">pid</span> <span class="mi">23720</span> <span class="n">at</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">08</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mi">45</span> <span class="o">-----</span>
</span><span class='line'><span class="n">Cmd</span> <span class="nl">line:</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">lapisy</span><span class="o">.</span><span class="na">apptemplate</span>
</span><span class='line'><span class="n">Build</span> <span class="nl">fingerprint:</span> <span class="err">&#39;</span><span class="n">Android</span><span class="o">/</span><span class="n">sdk_phone_x86_64</span><span class="o">/</span><span class="nl">generic_x86_64:</span><span class="mf">8.0</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">OSR1</span><span class="o">.</span><span class="mf">180418.004</span><span class="o">/</span><span class="mi">4931640</span><span class="o">:</span><span class="n">userdebug</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">keys</span><span class="err">&#39;</span>
</span><span class='line'><span class="nl">ABI:</span> <span class="err">&#39;</span><span class="n">x86_64</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">Build</span> <span class="nl">type:</span> <span class="n">optimized</span>
</span><span class='line'><span class="n">Zygote</span> <span class="n">loaded</span> <span class="n">classes</span><span class="o">=</span><span class="mi">4675</span> <span class="n">post</span> <span class="n">zygote</span> <span class="n">classes</span><span class="o">=</span><span class="mi">217</span>
</span><span class='line'><span class="n">Intern</span> <span class="nl">table:</span> <span class="mi">42644</span> <span class="n">strong</span><span class="o">;</span> <span class="mi">137</span> <span class="n">weak</span>
</span><span class='line'><span class="nl">JNI:</span> <span class="n">CheckJNI</span> <span class="n">is</span> <span class="n">on</span><span class="o">;</span> <span class="n">globals</span><span class="o">=</span><span class="mi">524</span> <span class="o">(</span><span class="n">plus</span> <span class="mi">22</span> <span class="n">weak</span><span class="o">)</span>
</span><span class='line'><span class="nl">Libraries:</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libandroid</span><span class="o">.</span><span class="na">so</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libcompiler_rt</span><span class="o">.</span><span class="na">so</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libjavacrypto</span><span class="o">.</span><span class="na">so</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libjnigraphics</span><span class="o">.</span><span class="na">so</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libmedia_jni</span><span class="o">.</span><span class="na">so</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libsoundpool</span><span class="o">.</span><span class="na">so</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libwebviewchromium_loader</span><span class="o">.</span><span class="na">so</span> <span class="n">libjavacore</span><span class="o">.</span><span class="na">so</span> <span class="n">libopenjdk</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="mi">9</span><span class="o">)</span>
</span><span class='line'><span class="nl">Heap:</span> <span class="mi">67</span><span class="o">%</span> <span class="n">free</span><span class="o">,</span> <span class="mi">725</span><span class="n">KB</span><span class="o">/</span><span class="mi">2</span><span class="n">MB</span><span class="o">;</span> <span class="mi">17739</span> <span class="n">objects</span>
</span><span class='line'><span class="n">Dumping</span> <span class="n">cumulative</span> <span class="n">Gc</span> <span class="n">timings</span>
</span><span class='line'><span class="n">Start</span> <span class="n">Dumping</span> <span class="n">histograms</span> <span class="k">for</span> <span class="mi">1</span> <span class="n">iterations</span> <span class="k">for</span> <span class="n">concurrent</span> <span class="n">copying</span>
</span><span class='line'><span class="nl">ResumeRunnableThreads:</span>    <span class="nl">Sum:</span> <span class="mf">155.370</span><span class="n">ms</span> <span class="mi">99</span><span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="na">I</span><span class="o">.</span> <span class="mf">155.370</span><span class="n">ms</span><span class="o">-</span><span class="mf">155.370</span><span class="n">ms</span> <span class="nl">Avg:</span> <span class="mf">155.370</span><span class="n">ms</span> <span class="nl">Max:</span> <span class="mf">155.370</span><span class="n">ms</span>
</span><span class='line'><span class="nl">ThreadListFlip:</span>   <span class="nl">Sum:</span> <span class="mf">90.071</span><span class="n">ms</span> <span class="mi">99</span><span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="na">I</span><span class="o">.</span> <span class="mf">90.071</span><span class="n">ms</span><span class="o">-</span><span class="mf">90.071</span><span class="n">ms</span> <span class="nl">Avg:</span> <span class="mf">90.071</span><span class="n">ms</span> <span class="nl">Max:</span> <span class="mf">90.071</span><span class="n">ms</span>
</span><span class='line'><span class="nl">ProcessMarkStack:</span> <span class="nl">Sum:</span> <span class="mf">30.911</span><span class="n">ms</span> <span class="mi">99</span><span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="na">I</span><span class="o">.</span> <span class="mf">30.911</span><span class="n">ms</span><span class="o">-</span><span class="mf">30.911</span><span class="n">ms</span> <span class="nl">Avg:</span> <span class="mf">30.911</span><span class="n">ms</span> <span class="nl">Max:</span> <span class="mf">30.911</span><span class="n">ms</span>
</span><span class='line'><span class="nl">SweepSystemWeaks:</span> <span class="nl">Sum:</span> <span class="mf">8.240</span><span class="n">ms</span> <span class="mi">99</span><span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="na">I</span><span class="o">.</span> <span class="mf">8.240</span><span class="n">ms</span><span class="o">-</span><span class="mf">8.240</span><span class="n">ms</span> <span class="nl">Avg:</span> <span class="mf">8.240</span><span class="n">ms</span> <span class="nl">Max:</span> <span class="mf">8.240</span><span class="n">ms</span>
</span><span class='line'><span class="nl">VisitConcurrentRoots:</span> <span class="nl">Sum:</span> <span class="mf">5.951</span><span class="n">ms</span> <span class="mi">99</span><span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="na">I</span><span class="o">.</span> <span class="mf">5.951</span><span class="n">ms</span><span class="o">-</span><span class="mf">5.951</span><span class="n">ms</span> <span class="nl">Avg:</span> <span class="mf">5.951</span><span class="n">ms</span> <span class="nl">Max:</span> <span class="mf">5.951</span><span class="n">ms</span>
</span><span class='line'><span class="o">......</span>
</span><span class='line'><span class="o">......</span>
</span><span class='line'><span class="n">concurrent</span> <span class="n">copying</span> <span class="n">total</span> <span class="nl">time:</span> <span class="mf">311.388</span><span class="n">ms</span> <span class="n">mean</span> <span class="nl">time:</span> <span class="mf">311.388</span><span class="n">ms</span>
</span><span class='line'><span class="n">concurrent</span> <span class="n">copying</span> <span class="nl">freed:</span> <span class="mi">5008</span> <span class="n">objects</span> <span class="n">with</span> <span class="n">total</span> <span class="n">size</span> <span class="mi">2</span><span class="n">MB</span>
</span><span class='line'><span class="n">concurrent</span> <span class="n">copying</span> <span class="nl">throughput:</span> <span class="mf">16102.9</span><span class="o">/</span><span class="n">s</span> <span class="o">/</span> <span class="mi">8</span><span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">Cumulative</span> <span class="n">bytes</span> <span class="n">moved</span> <span class="mi">2290824</span>
</span><span class='line'><span class="n">Cumulative</span> <span class="n">objects</span> <span class="n">moved</span> <span class="mi">51583</span>
</span><span class='line'><span class="n">Total</span> <span class="n">time</span> <span class="n">spent</span> <span class="n">in</span> <span class="nl">GC:</span> <span class="mf">311.388</span><span class="n">ms</span>
</span><span class='line'><span class="n">Mean</span> <span class="n">GC</span> <span class="n">size</span> <span class="nl">throughput:</span> <span class="mi">8</span><span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">Mean</span> <span class="n">GC</span> <span class="n">object</span> <span class="nl">throughput:</span> <span class="mf">16082.8</span> <span class="n">objects</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">allocations</span> <span class="mi">22747</span>
</span><span class='line'><span class="n">Total</span> <span class="n">bytes</span> <span class="n">allocated</span> <span class="mi">3</span><span class="n">MB</span>
</span><span class='line'><span class="n">Total</span> <span class="n">bytes</span> <span class="n">freed</span> <span class="mi">2</span><span class="n">MB</span>
</span><span class='line'><span class="n">Free</span> <span class="n">memory</span> <span class="mi">1504</span><span class="n">KB</span>
</span><span class='line'><span class="n">Free</span> <span class="n">memory</span> <span class="n">until</span> <span class="n">GC</span> <span class="mi">1504</span><span class="n">KB</span>
</span><span class='line'><span class="n">Free</span> <span class="n">memory</span> <span class="n">until</span> <span class="n">OOME</span> <span class="mi">383</span><span class="n">MB</span>
</span><span class='line'><span class="n">Total</span> <span class="n">memory</span> <span class="mi">2</span><span class="n">MB</span>
</span><span class='line'><span class="n">Max</span> <span class="n">memory</span> <span class="mi">384</span><span class="n">MB</span>
</span><span class='line'><span class="n">Zygote</span> <span class="n">space</span> <span class="n">size</span> <span class="mi">588</span><span class="n">KB</span>
</span><span class='line'><span class="n">Total</span> <span class="n">mutator</span> <span class="n">paused</span> <span class="nl">time:</span> <span class="mi">606</span><span class="n">us</span>
</span><span class='line'><span class="n">Total</span> <span class="n">time</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">GC</span> <span class="n">to</span> <span class="nl">complete:</span> <span class="mf">131.764</span><span class="n">ms</span>
</span><span class='line'><span class="n">Total</span> <span class="n">GC</span> <span class="nl">count:</span> <span class="mi">1</span>
</span><span class='line'><span class="n">Total</span> <span class="n">GC</span> <span class="nl">time:</span> <span class="mf">311.388</span><span class="n">ms</span>
</span><span class='line'><span class="n">Total</span> <span class="n">blocking</span> <span class="n">GC</span> <span class="nl">count:</span> <span class="mi">0</span>
</span><span class='line'><span class="n">Total</span> <span class="n">blocking</span> <span class="n">GC</span> <span class="nl">time:</span> <span class="mi">0</span>
</span><span class='line'><span class="n">Histogram</span> <span class="n">of</span> <span class="n">GC</span> <span class="n">count</span> <span class="n">per</span> <span class="mi">10000</span> <span class="nl">ms:</span> <span class="mi">0</span><span class="o">:</span><span class="mi">1</span>
</span><span class='line'><span class="n">Histogram</span> <span class="n">of</span> <span class="n">blocking</span> <span class="n">GC</span> <span class="n">count</span> <span class="n">per</span> <span class="mi">10000</span> <span class="nl">ms:</span> <span class="mi">0</span><span class="o">:</span><span class="mi">1</span>
</span><span class='line'><span class="n">Registered</span> <span class="kd">native</span> <span class="n">bytes</span> <span class="nl">allocated:</span> <span class="mi">3529742</span>
</span><span class='line'><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">lapisy</span><span class="o">.</span><span class="na">apptemplate</span><span class="o">-</span><span class="mi">2</span><span class="n">XStSJcJb6Nk1a2drTSdOw</span><span class="o">==/</span><span class="n">oat</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">base</span><span class="o">.</span><span class="na">odex</span><span class="o">:</span> <span class="n">quicken</span>
</span><span class='line'><span class="n">Current</span> <span class="n">JIT</span> <span class="n">code</span> <span class="n">cache</span> <span class="nl">size:</span> <span class="mi">3</span><span class="n">KB</span>
</span><span class='line'><span class="n">Current</span> <span class="n">JIT</span> <span class="n">data</span> <span class="n">cache</span> <span class="nl">size:</span> <span class="mi">4</span><span class="n">KB</span>
</span><span class='line'><span class="n">Current</span> <span class="n">JIT</span> <span class="nl">capacity:</span> <span class="mi">64</span><span class="n">KB</span>
</span><span class='line'><span class="n">Current</span> <span class="n">number</span> <span class="n">of</span> <span class="n">JIT</span> <span class="n">code</span> <span class="n">cache</span> <span class="nl">entries:</span> <span class="mi">10</span>
</span><span class='line'><span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">JIT</span> <span class="nl">compilations:</span> <span class="mi">10</span>
</span><span class='line'><span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">JIT</span> <span class="n">compilations</span> <span class="k">for</span> <span class="n">on</span> <span class="n">stack</span> <span class="nl">replacement:</span> <span class="mi">0</span>
</span><span class='line'><span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">JIT</span> <span class="n">code</span> <span class="n">cache</span> <span class="nl">collections:</span> <span class="mi">0</span>
</span><span class='line'><span class="n">Memory</span> <span class="n">used</span> <span class="k">for</span> <span class="n">stack</span> <span class="nl">maps:</span> <span class="nl">Avg:</span> <span class="mi">124</span><span class="n">B</span> <span class="nl">Max:</span> <span class="mi">344</span><span class="n">B</span> <span class="nl">Min:</span> <span class="mi">24</span><span class="n">B</span>
</span><span class='line'><span class="n">Memory</span> <span class="n">used</span> <span class="k">for</span> <span class="n">compiled</span> <span class="nl">code:</span> <span class="nl">Avg:</span> <span class="mi">357</span><span class="n">B</span> <span class="nl">Max:</span> <span class="mi">1448</span><span class="n">B</span> <span class="nl">Min:</span> <span class="mi">1</span><span class="n">B</span>
</span><span class='line'><span class="n">Memory</span> <span class="n">used</span> <span class="k">for</span> <span class="n">profiling</span> <span class="nl">info:</span> <span class="nl">Avg:</span> <span class="mi">172</span><span class="n">B</span> <span class="nl">Max:</span> <span class="mi">1208</span><span class="n">B</span> <span class="nl">Min:</span> <span class="mi">32</span><span class="n">B</span>
</span><span class='line'><span class="n">Start</span> <span class="n">Dumping</span> <span class="n">histograms</span> <span class="k">for</span> <span class="mi">10</span> <span class="n">iterations</span> <span class="k">for</span> <span class="n">JIT</span> <span class="n">timings</span>
</span><span class='line'><span class="nl">Compiling:</span>    <span class="nl">Sum:</span> <span class="mf">111.851</span><span class="n">ms</span> <span class="mi">99</span><span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="na">I</span><span class="o">.</span> <span class="mf">0.084</span><span class="n">ms</span><span class="o">-</span><span class="mf">38.480</span><span class="n">ms</span> <span class="nl">Avg:</span> <span class="mf">11.185</span><span class="n">ms</span> <span class="nl">Max:</span> <span class="mf">38.498</span><span class="n">ms</span>
</span><span class='line'><span class="nl">TrimMaps:</span> <span class="nl">Sum:</span> <span class="mf">60.285</span><span class="n">ms</span> <span class="mi">99</span><span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="na">I</span><span class="o">.</span> <span class="mf">0.010</span><span class="n">ms</span><span class="o">-</span><span class="mf">56.279</span><span class="n">ms</span> <span class="nl">Avg:</span> <span class="mf">6.028</span><span class="n">ms</span> <span class="nl">Max:</span> <span class="mf">58.717</span><span class="n">ms</span>
</span><span class='line'><span class="n">Done</span> <span class="n">Dumping</span> <span class="n">histograms</span>
</span><span class='line'><span class="n">Memory</span> <span class="n">used</span> <span class="k">for</span> <span class="nl">compilation:</span> <span class="nl">Avg:</span> <span class="mi">91</span><span class="n">KB</span> <span class="nl">Max:</span> <span class="mi">256</span><span class="n">KB</span> <span class="nl">Min:</span> <span class="mi">15</span><span class="n">KB</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_bytes_written</span><span class="o">=</span><span class="mi">0</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_number_of_writes</span><span class="o">=</span><span class="mi">0</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_number_of_code_cache_queries</span><span class="o">=</span><span class="mi">0</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_number_of_skipped_writes</span><span class="o">=</span><span class="mi">0</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_number_of_failed_writes</span><span class="o">=</span><span class="mi">0</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_ms_of_sleep</span><span class="o">=</span><span class="mi">5000</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_ms_of_work</span><span class="o">=</span><span class="mi">0</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">max_number_profile_entries_cached</span><span class="o">=</span><span class="mi">1</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_number_of_hot_spikes</span><span class="o">=</span><span class="mi">0</span>
</span><span class='line'><span class="n">ProfileSaver</span> <span class="n">total_number_of_wake_ups</span><span class="o">=</span><span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="n">all</span> <span class="nl">histogram:</span>  <span class="nl">Sum:</span> <span class="mi">189</span><span class="n">us</span> <span class="mi">99</span><span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="na">I</span><span class="o">.</span> <span class="mf">0.320</span><span class="n">us</span><span class="o">-</span><span class="mi">43</span><span class="n">us</span> <span class="nl">Avg:</span> <span class="mf">23.625</span><span class="n">us</span> <span class="nl">Max:</span> <span class="mi">43</span><span class="n">us</span>
</span><span class='line'><span class="n">DALVIK</span> <span class="nf">THREADS</span> <span class="o">(</span><span class="mi">16</span><span class="o">):</span>
</span><span class='line'><span class="s">&quot;Signal Catcher&quot;</span> <span class="n">daemon</span> <span class="n">prio</span><span class="o">=</span><span class="mi">5</span> <span class="n">tid</span><span class="o">=</span><span class="mi">3</span> <span class="n">Runnable</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">group</span><span class="o">=</span><span class="s">&quot;system&quot;</span> <span class="n">sCount</span><span class="o">=</span><span class="mi">0</span> <span class="n">dsCount</span><span class="o">=</span><span class="mi">0</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span> <span class="n">obj</span><span class="o">=</span><span class="mh">0x14ea5df8</span> <span class="n">self</span><span class="o">=</span><span class="mh">0x7e8c4905c400</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">sysTid</span><span class="o">=</span><span class="mi">23726</span> <span class="n">nice</span><span class="o">=</span><span class="mi">0</span> <span class="n">cgrp</span><span class="o">=</span><span class="k">default</span> <span class="n">sched</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span> <span class="n">handle</span><span class="o">=</span><span class="mh">0x7e8c3fc064f0</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">state</span><span class="o">=</span><span class="n">R</span> <span class="n">schedstat</span><span class="o">=(</span> <span class="mi">5286484</span> <span class="mi">3613279</span> <span class="mi">4</span> <span class="o">)</span> <span class="n">utm</span><span class="o">=</span><span class="mi">0</span> <span class="n">stm</span><span class="o">=</span><span class="mi">0</span> <span class="n">core</span><span class="o">=</span><span class="mi">0</span> <span class="n">HZ</span><span class="o">=</span><span class="mi">100</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">stack</span><span class="o">=</span><span class="mh">0x7e8c3fb0c000</span><span class="o">-</span><span class="mh">0x7e8c3fb0e000</span> <span class="n">stackSize</span><span class="o">=</span><span class="mi">1005</span><span class="n">KB</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">held</span> <span class="n">mutexes</span><span class="o">=</span> <span class="s">&quot;mutator lock&quot;</span><span class="o">(</span><span class="n">shared</span> <span class="n">held</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">00</span> <span class="n">pc</span> <span class="mi">0000000000435</span><span class="n">ca5</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art15DumpNativeStackERNSt3__113basic_ostreamIcNS0_11char_traitsIcEEEEiP12BacktraceMapPKcPNS_9ArtMethodEPv</span><span class="o">+</span><span class="mi">213</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">01</span> <span class="n">pc</span> <span class="mi">0000000000515</span><span class="n">b12</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZNK3art6Thread9DumpStackERNSt3__113basic_ostreamIcNS1_11char_traitsIcEEEEbP12BacktraceMapb</span><span class="o">+</span><span class="mi">322</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">02</span> <span class="n">pc</span> <span class="mi">000000000052</span><span class="n">e56e</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art14DumpCheckpoint3RunEPNS_6ThreadE</span><span class="o">+</span><span class="mi">926</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">03</span> <span class="n">pc</span> <span class="mi">0000000000526399</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art10ThreadList13RunCheckpointEPNS_7ClosureES2_</span><span class="o">+</span><span class="mi">489</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">04</span> <span class="n">pc</span> <span class="mi">0000000000525</span><span class="n">d8b</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art10ThreadList4DumpERNSt3__113basic_ostreamIcNS1_11char_traitsIcEEEEb</span><span class="o">+</span><span class="mi">747</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">05</span> <span class="n">pc</span> <span class="mi">0000000000525943</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art10ThreadList14DumpForSigQuitERNSt3__113basic_ostreamIcNS1_11char_traitsIcEEEE</span><span class="o">+</span><span class="mi">867</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">06</span> <span class="n">pc</span> <span class="mi">00000000004</span><span class="n">f7c29</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art7Runtime14DumpForSigQuitERNSt3__113basic_ostreamIcNS1_11char_traitsIcEEEE</span><span class="o">+</span><span class="mi">201</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">07</span> <span class="n">pc</span> <span class="mi">000000000050228</span><span class="n">e</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art13SignalCatcher13HandleSigQuitEv</span><span class="o">+</span><span class="mi">1790</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">08</span> <span class="n">pc</span> <span class="mi">0000000000500</span><span class="n">fca</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art13SignalCatcher3RunEPv</span><span class="o">+</span><span class="mi">378</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">09</span> <span class="n">pc</span> <span class="mi">000000000007706</span><span class="n">b</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZL15__pthread_startPv</span><span class="o">+</span><span class="mi">27</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">10</span> <span class="n">pc</span> <span class="mi">0000000000028</span><span class="n">aad</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">__start_thread</span><span class="o">+</span><span class="mi">61</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">11</span> <span class="n">pc</span> <span class="mi">0000000000027515</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">__bionic_clone</span><span class="o">+</span><span class="mi">53</span><span class="o">)</span>
</span><span class='line'>  <span class="o">(</span><span class="n">no</span> <span class="n">managed</span> <span class="n">stack</span> <span class="n">frames</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="s">&quot;main&quot;</span> <span class="n">prio</span><span class="o">=</span><span class="mi">5</span> <span class="n">tid</span><span class="o">=</span><span class="mi">1</span> <span class="n">Sleeping</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">group</span><span class="o">=</span><span class="s">&quot;main&quot;</span> <span class="n">sCount</span><span class="o">=</span><span class="mi">1</span> <span class="n">dsCount</span><span class="o">=</span><span class="mi">0</span> <span class="n">flags</span><span class="o">=</span><span class="mi">1</span> <span class="n">obj</span><span class="o">=</span><span class="mh">0x73ae4670</span> <span class="n">self</span><span class="o">=</span><span class="mh">0x7e8c490bea00</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">sysTid</span><span class="o">=</span><span class="mi">23720</span> <span class="n">nice</span><span class="o">=-</span><span class="mi">10</span> <span class="n">cgrp</span><span class="o">=</span><span class="k">default</span> <span class="n">sched</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span> <span class="n">handle</span><span class="o">=</span><span class="mh">0x7e8c4df92a08</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">state</span><span class="o">=</span><span class="n">S</span> <span class="n">schedstat</span><span class="o">=(</span> <span class="mi">438163483</span> <span class="mi">342098452</span> <span class="mi">207</span> <span class="o">)</span> <span class="n">utm</span><span class="o">=</span><span class="mi">29</span> <span class="n">stm</span><span class="o">=</span><span class="mi">14</span> <span class="n">core</span><span class="o">=</span><span class="mi">1</span> <span class="n">HZ</span><span class="o">=</span><span class="mi">100</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">stack</span><span class="o">=</span><span class="mh">0x7fffbf9e8000</span><span class="o">-</span><span class="mh">0x7fffbf9ea000</span> <span class="n">stackSize</span><span class="o">=</span><span class="mi">8</span><span class="n">MB</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">held</span> <span class="n">mutexes</span><span class="o">=</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">Native</span> <span class="n">method</span><span class="o">)</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">sleeping</span> <span class="n">on</span> <span class="o">&lt;</span><span class="mh">0x03cabe95</span><span class="o">&gt;</span> <span class="o">(</span><span class="n">a</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">373</span><span class="o">)</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">locked</span> <span class="o">&lt;</span><span class="mh">0x03cabe95</span><span class="o">&gt;</span> <span class="o">(</span><span class="n">a</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">314</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">SystemClock</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">122</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">lapisy</span><span class="o">.</span><span class="na">apptemplate</span><span class="o">.</span><span class="na">MainActivity$1</span><span class="o">.</span><span class="na">onClick</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">77</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View</span><span class="o">.</span><span class="na">performClick</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">6256</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View$PerformClick</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">24701</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Handler</span><span class="o">.</span><span class="na">handleCallback</span><span class="o">(</span><span class="n">Handler</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">789</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Handler</span><span class="o">.</span><span class="na">dispatchMessage</span><span class="o">(</span><span class="n">Handler</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">98</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">(</span><span class="n">Looper</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">164</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">ActivityThread</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">6541</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">Native</span> <span class="n">method</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Zygote$MethodAndArgsCaller</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">Zygote</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">240</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">ZygoteInit</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">ZygoteInit</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">767</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="s">&quot;Jit thread pool worker thread 0&quot;</span> <span class="n">daemon</span> <span class="n">prio</span><span class="o">=</span><span class="mi">5</span> <span class="n">tid</span><span class="o">=</span><span class="mi">2</span> <span class="n">Native</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">group</span><span class="o">=</span><span class="s">&quot;main&quot;</span> <span class="n">sCount</span><span class="o">=</span><span class="mi">1</span> <span class="n">dsCount</span><span class="o">=</span><span class="mi">0</span> <span class="n">flags</span><span class="o">=</span><span class="mi">1</span> <span class="n">obj</span><span class="o">=</span><span class="mh">0x14e924b8</span> <span class="n">self</span><span class="o">=</span><span class="mh">0x7e8c3f80e000</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">sysTid</span><span class="o">=</span><span class="mi">23725</span> <span class="n">nice</span><span class="o">=</span><span class="mi">9</span> <span class="n">cgrp</span><span class="o">=</span><span class="k">default</span> <span class="n">sched</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span> <span class="n">handle</span><span class="o">=</span><span class="mh">0x7e8c3fd074f0</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">state</span><span class="o">=</span><span class="n">S</span> <span class="n">schedstat</span><span class="o">=(</span> <span class="mi">17625138</span> <span class="mi">213848019</span> <span class="mi">39</span> <span class="o">)</span> <span class="n">utm</span><span class="o">=</span><span class="mi">0</span> <span class="n">stm</span><span class="o">=</span><span class="mi">1</span> <span class="n">core</span><span class="o">=</span><span class="mi">0</span> <span class="n">HZ</span><span class="o">=</span><span class="mi">100</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">stack</span><span class="o">=</span><span class="mh">0x7e8c3fc09000</span><span class="o">-</span><span class="mh">0x7e8c3fc0b000</span> <span class="n">stackSize</span><span class="o">=</span><span class="mi">1021</span><span class="n">KB</span>
</span><span class='line'>  <span class="o">|</span> <span class="n">held</span> <span class="n">mutexes</span><span class="o">=</span>
</span><span class='line'>  <span class="nl">kernel:</span> <span class="n">futex_wait_queue_me</span><span class="o">+</span><span class="mh">0xdf</span><span class="o">/</span><span class="mh">0x130</span>
</span><span class='line'>  <span class="nl">kernel:</span> <span class="n">futex_wait</span><span class="o">+</span><span class="mh">0x113</span><span class="o">/</span><span class="mh">0x22e</span>
</span><span class='line'>  <span class="nl">kernel:</span> <span class="n">do_futex</span><span class="o">+</span><span class="mh">0xbe</span><span class="o">/</span><span class="mh">0x825</span>
</span><span class='line'>  <span class="nl">kernel:</span> <span class="n">SyS_futex</span><span class="o">+</span><span class="mh">0xbd</span><span class="o">/</span><span class="mh">0x124</span>
</span><span class='line'>  <span class="nl">kernel:</span> <span class="n">system_call_fastpath</span><span class="o">+</span><span class="mh">0x12</span><span class="o">/</span><span class="mh">0x17</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">00</span> <span class="n">pc</span> <span class="mi">00000000000276</span><span class="n">f6</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">syscall</span><span class="o">+</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">01</span> <span class="n">pc</span> <span class="mi">000000000014</span><span class="n">d38e</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art17ConditionVariable16WaitHoldingLocksEPNS_6ThreadE</span><span class="o">+</span><span class="mi">110</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">02</span> <span class="n">pc</span> <span class="mi">0000000000530012</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art10ThreadPool7GetTaskEPNS_6ThreadE</span><span class="o">+</span><span class="mi">322</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">03</span> <span class="n">pc</span> <span class="mi">000000000052</span><span class="n">f4a1</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art16ThreadPoolWorker3RunEv</span><span class="o">+</span><span class="mi">97</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">04</span> <span class="n">pc</span> <span class="mi">000000000052</span><span class="n">ef53</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libart</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZN3art16ThreadPoolWorker8CallbackEPv</span><span class="o">+</span><span class="mi">131</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">05</span> <span class="n">pc</span> <span class="mi">000000000007706</span><span class="n">b</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">_ZL15__pthread_startPv</span><span class="o">+</span><span class="mi">27</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">06</span> <span class="n">pc</span> <span class="mi">0000000000028</span><span class="n">aad</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">__start_thread</span><span class="o">+</span><span class="mi">61</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">native</span><span class="o">:</span> <span class="err">#</span><span class="mi">07</span> <span class="n">pc</span> <span class="mi">0000000000027515</span>  <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="na">so</span> <span class="o">(</span><span class="n">__bionic_clone</span><span class="o">+</span><span class="mi">53</span><span class="o">)</span>
</span><span class='line'>  <span class="o">(</span><span class="n">no</span> <span class="n">managed</span> <span class="n">stack</span> <span class="n">frames</span><span class="o">)</span>
</span><span class='line'>  <span class="o">......</span>
</span><span class='line'>  <span class="o">......</span>
</span><span class='line'>    <span class="o">-----</span> <span class="n">end</span> <span class="mi">23720</span> <span class="o">-----</span>
</span></code></pre></td></tr></table></div></figure>


<p>那么问题来了，这里就会产生几个问题：</p>

<p>&#8195;1. 这些日志是在哪里收集的呢？</p>

<p>&#8195;2. 收集什么信息？如何收集的？</p>

<p>只有弄明白这两个问题，才能更好的理解和处理ANR问题。</p>

<h3>二：ANR日志的收集过程</h3>

<p>当系统发生anr的时候，都会调用的<code>AppErrors</code>的<code>appNotResponding</code>方法，那我们现在慢慢来看这个函数的整个功能。代码有点长，但是不急，我们慢慢来看（代码基本上没有删减，因为我觉得这些代码得一遍一遍的看，当时觉得不重要的，说不定就是挺重要的，删除了就再也看不到了，这是我自己的一个习惯）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="kt">void</span> <span class="nf">appNotResponding</span><span class="o">(</span><span class="n">ProcessRecord</span> <span class="n">app</span><span class="o">,</span> <span class="n">ActivityRecord</span> <span class="n">activity</span><span class="o">,</span>
</span><span class='line'>        <span class="n">ActivityRecord</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">aboveSystem</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">annotation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">firstPids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="mi">5</span><span class="o">);</span>
</span><span class='line'>    <span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">lastPids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;(</span><span class="mi">20</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mService</span><span class="o">.</span><span class="na">mController</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// 0 == continue, -1 = kill process immediately</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">mService</span><span class="o">.</span><span class="na">mController</span><span class="o">.</span><span class="na">appEarlyNotResponding</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span><span class="o">,</span> <span class="n">annotation</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span> <span class="o">!=</span> <span class="n">MY_PID</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">app</span><span class="o">.</span><span class="na">kill</span><span class="o">(</span><span class="s">&quot;anr&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mService</span><span class="o">.</span><span class="na">mController</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">setActivityController</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">long</span> <span class="n">anrTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">MONITOR_CPU_USAGE</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mService</span><span class="o">.</span><span class="na">updateCpuStatsNow</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Unless configured otherwise, swallow ANRs in background processes &amp; kill the process.</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">showBackground</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">mContext</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">(),</span>
</span><span class='line'>            <span class="n">Settings</span><span class="o">.</span><span class="na">Secure</span><span class="o">.</span><span class="na">ANR_SHOW_BACKGROUND</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">isSilentANR</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mService</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// PowerManager.reboot() can block for a long time, so ignore ANRs while shutting down.</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mService</span><span class="o">.</span><span class="na">mShuttingDown</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;During shutdown skipping ANR: &quot;</span> <span class="o">+</span> <span class="n">app</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">notResponding</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Skipping duplicate ANR: &quot;</span> <span class="o">+</span> <span class="n">app</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">crashing</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Crashing app skipping ANR: &quot;</span> <span class="o">+</span> <span class="n">app</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">killedByAm</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;App already killed by AM skipping ANR: &quot;</span> <span class="o">+</span> <span class="n">app</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">killed</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Skipping died app ANR: &quot;</span> <span class="o">+</span> <span class="n">app</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// In case we come through here for the same app before completing</span>
</span><span class='line'>        <span class="c1">// this one, mark as anring now so we will bail out.</span>
</span><span class='line'>        <span class="n">app</span><span class="o">.</span><span class="na">notResponding</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Log the ANR to the event log.</span>
</span><span class='line'>          <span class="c1">//开始使用EventLog打印ANR的event log</span>
</span><span class='line'>        <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">AM_ANR</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">userId</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span><span class="o">,</span>
</span><span class='line'>                <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">flags</span><span class="o">,</span> <span class="n">annotation</span><span class="o">);</span>
</span><span class='line'>                  <span class="c1">//把当前的app添加到最先开始收集栈的列表中</span>
</span><span class='line'>        <span class="n">firstPids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//如果是发生在后台的anr，那么就不收集</span>
</span><span class='line'>        <span class="n">isSilentANR</span> <span class="o">=</span> <span class="o">!</span><span class="n">showBackground</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isInterestingForBackgroundTraces</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">isSilentANR</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">parentPid</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span><span class="o">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">.</span><span class="na">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">parentPid</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">pid</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">parentPid</span> <span class="o">!=</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span><span class="o">)</span> <span class="n">firstPids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">parentPid</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">MY_PID</span> <span class="o">!=</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span> <span class="o">&amp;&amp;</span> <span class="n">MY_PID</span> <span class="o">!=</span> <span class="n">parentPid</span><span class="o">)</span> <span class="n">firstPids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">MY_PID</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">mService</span><span class="o">.</span><span class="na">mLruProcesses</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ProcessRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mService</span><span class="o">.</span><span class="na">mLruProcesses</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">pid</span><span class="o">;</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span> <span class="o">&amp;&amp;</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">parentPid</span> <span class="o">&amp;&amp;</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">MY_PID</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">persistent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">firstPids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pid</span><span class="o">);</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Adding persistent proc: &quot;</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
</span><span class='line'>                        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">treatLikeActivity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">firstPids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pid</span><span class="o">);</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Adding likely IME: &quot;</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
</span><span class='line'>                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">lastPids</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Adding ANR proc: &quot;</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Log the ANR to the main log.</span>
</span><span class='line'>      <span class="c1">//这个地方就是向我们的main log中打印ANR日志</span>
</span><span class='line'>      <span class="c1">//注释1</span>
</span><span class='line'>    <span class="n">StringBuilder</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="o">();</span>
</span><span class='line'>    <span class="n">info</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>    <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;ANR in &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">activity</span><span class="o">.</span><span class="na">shortComponentName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; (&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">shortComponentName</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;PID: &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">pid</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;Reason: &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">annotation</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;Parent: &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">shortComponentName</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ProcessCpuTracker</span> <span class="n">processCpuTracker</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ProcessCpuTracker</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// don&#39;t dump native PIDs for background ANRs unless it is the process of interest</span>
</span><span class='line'>    <span class="n">String</span><span class="o">[]</span> <span class="n">nativeProcs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">isSilentANR</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NATIVE_STACKS_OF_INTEREST</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">NATIVE_STACKS_OF_INTEREST</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">nativeProcs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="n">app</span><span class="o">.</span><span class="na">processName</span> <span class="o">};</span>
</span><span class='line'>                <span class="k">break</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">nativeProcs</span> <span class="o">=</span> <span class="n">NATIVE_STACKS_OF_INTEREST</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span><span class="o">[]</span> <span class="n">pids</span> <span class="o">=</span> <span class="n">nativeProcs</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">Process</span><span class="o">.</span><span class="na">getPidsForCommands</span><span class="o">(</span><span class="n">nativeProcs</span><span class="o">);</span>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">nativePids</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">pids</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">nativePids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="n">pids</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">:</span> <span class="n">pids</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">nativePids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// For background ANRs, don&#39;t pass the ProcessCpuTracker to</span>
</span><span class='line'>    <span class="c1">// avoid spending 1/2 second collecting stats to rank lastPids.</span>
</span><span class='line'>      <span class="c1">//开始收集发生anr的栈信息到制定的文件中</span>
</span><span class='line'>      <span class="c1">//具体分析看[2.1节的分析]</span>
</span><span class='line'>    <span class="n">File</span> <span class="n">tracesFile</span> <span class="o">=</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">dumpStackTraces</span><span class="o">(</span>
</span><span class='line'>            <span class="kc">true</span><span class="o">,</span> <span class="n">firstPids</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">isSilentANR</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">processCpuTracker</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">isSilentANR</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">lastPids</span><span class="o">,</span>
</span><span class='line'>            <span class="n">nativePids</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">String</span> <span class="n">cpuInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">MONITOR_CPU_USAGE</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mService</span><span class="o">.</span><span class="na">updateCpuStatsNow</span><span class="o">();</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mService</span><span class="o">.</span><span class="na">mProcessCpuTracker</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">//这里会打印cpu中的信息</span>
</span><span class='line'>              <span class="c1">//具体看[2.2节分析]</span>
</span><span class='line'>            <span class="n">cpuInfo</span> <span class="o">=</span> <span class="n">mService</span><span class="o">.</span><span class="na">mProcessCpuTracker</span><span class="o">.</span><span class="na">printCurrentState</span><span class="o">(</span><span class="n">anrTime</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">processCpuTracker</span><span class="o">.</span><span class="na">printCurrentLoad</span><span class="o">());</span>
</span><span class='line'>        <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">cpuInfo</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">info</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">processCpuTracker</span><span class="o">.</span><span class="na">printCurrentState</span><span class="o">(</span><span class="n">anrTime</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">tracesFile</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// There is no trace file, so dump (only) the alleged culprit&#39;s threads to the log</span>
</span><span class='line'>        <span class="n">Process</span><span class="o">.</span><span class="na">sendSignal</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">pid</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SIGNAL_QUIT</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StatsLog</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">StatsLog</span><span class="o">.</span><span class="na">ANR_OCCURRED</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span>
</span><span class='line'>            <span class="n">activity</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;unknown&quot;</span><span class="o">:</span> <span class="n">activity</span><span class="o">.</span><span class="na">shortComponentName</span><span class="o">,</span> <span class="n">annotation</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">info</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">isInstantApp</span><span class="o">()</span>
</span><span class='line'>                    <span class="o">?</span> <span class="n">StatsLog</span><span class="o">.</span><span class="na">ANROCCURRED__IS_INSTANT_APP__TRUE</span>
</span><span class='line'>                    <span class="o">:</span> <span class="n">StatsLog</span><span class="o">.</span><span class="na">ANROCCURRED__IS_INSTANT_APP__FALSE</span><span class="o">)</span>
</span><span class='line'>                    <span class="o">:</span> <span class="n">StatsLog</span><span class="o">.</span><span class="na">ANROCCURRED__IS_INSTANT_APP__UNAVAILABLE</span><span class="o">,</span>
</span><span class='line'>            <span class="n">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">isInterestingToUserLocked</span><span class="o">()</span>
</span><span class='line'>                    <span class="o">?</span> <span class="n">StatsLog</span><span class="o">.</span><span class="na">ANROCCURRED__FOREGROUND_STATE__FOREGROUND</span>
</span><span class='line'>                    <span class="o">:</span> <span class="n">StatsLog</span><span class="o">.</span><span class="na">ANROCCURRED__FOREGROUND_STATE__BACKGROUND</span><span class="o">)</span>
</span><span class='line'>                    <span class="o">:</span> <span class="n">StatsLog</span><span class="o">.</span><span class="na">ANROCCURRED__FOREGROUND_STATE__UNKNOWN</span><span class="o">);</span>
</span><span class='line'>    <span class="n">mService</span><span class="o">.</span><span class="na">addErrorToDropBox</span><span class="o">(</span><span class="s">&quot;anr&quot;</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">activity</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="n">annotation</span><span class="o">,</span>
</span><span class='line'>            <span class="n">cpuInfo</span><span class="o">,</span> <span class="n">tracesFile</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mService</span><span class="o">.</span><span class="na">mController</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// 0 == show dialog, 1 = keep waiting, -1 = kill process immediately</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">mService</span><span class="o">.</span><span class="na">mController</span><span class="o">.</span><span class="na">appNotResponding</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span> <span class="o">!=</span> <span class="n">MY_PID</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">app</span><span class="o">.</span><span class="na">kill</span><span class="o">(</span><span class="s">&quot;anr&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mService</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">mService</span><span class="o">.</span><span class="na">mServices</span><span class="o">.</span><span class="na">scheduleServiceTimeoutLocked</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="k">return</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mService</span><span class="o">.</span><span class="na">mController</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">setActivityController</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mService</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mService</span><span class="o">.</span><span class="na">mBatteryStatsService</span><span class="o">.</span><span class="na">noteProcessAnr</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">uid</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">isSilentANR</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">app</span><span class="o">.</span><span class="na">kill</span><span class="o">(</span><span class="s">&quot;bg anr&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Set the app&#39;s notResponding state, and look up the errorReportReceiver</span>
</span><span class='line'>          <span class="c1">//设置app的notResponding状态，并且查找errorreport的接受者</span>
</span><span class='line'>        <span class="n">makeAppNotRespondingLocked</span><span class="o">(</span><span class="n">app</span><span class="o">,</span>
</span><span class='line'>                <span class="n">activity</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">activity</span><span class="o">.</span><span class="na">shortComponentName</span> <span class="o">:</span> <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                <span class="n">annotation</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;ANR &quot;</span> <span class="o">+</span> <span class="n">annotation</span> <span class="o">:</span> <span class="s">&quot;ANR&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="n">info</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Bring up the infamous App Not Responding dialog</span>
</span><span class='line'>          <span class="c1">//发送消息弹出一个anr的弹窗</span>
</span><span class='line'>        <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
</span><span class='line'>        <span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">=</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">SHOW_NOT_RESPONDING_UI_MSG</span><span class="o">;</span>
</span><span class='line'>        <span class="n">msg</span><span class="o">.</span><span class="na">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AppNotRespondingDialog</span><span class="o">.</span><span class="na">Data</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">activity</span><span class="o">,</span> <span class="n">aboveSystem</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mService</span><span class="o">.</span><span class="na">mUiHandler</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8195;<strong>注释1</strong>：这个地方就是构造了我们main log中的头部最开始的信息，收集了anr发生的进程，主要原因，也就是下面这一段：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">08</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">46.009</span> <span class="mi">1638</span><span class="o">-</span><span class="mi">1668</span><span class="o">/</span><span class="n">system_process</span> <span class="n">E</span><span class="o">/</span><span class="nl">ActivityManager:</span> <span class="n">ANR</span> <span class="n">in</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">lapisy</span><span class="o">.</span><span class="na">apptemplate</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">lapisy</span><span class="o">.</span><span class="na">apptemplate</span><span class="o">/.</span><span class="na">MainActivity</span><span class="o">)</span>
</span><span class='line'>    <span class="nl">PID:</span> <span class="mi">23720</span>
</span><span class='line'>    <span class="nl">Reason:</span> <span class="n">Input</span> <span class="n">dispatching</span> <span class="n">timed</span> <span class="nf">out</span> <span class="o">(</span><span class="n">Waiting</span> <span class="n">to</span> <span class="n">send</span> <span class="n">non</span><span class="o">-</span><span class="n">key</span> <span class="n">event</span> <span class="n">because</span> <span class="n">the</span> <span class="n">touched</span> <span class="n">window</span> <span class="n">has</span> <span class="n">not</span> <span class="n">finished</span> <span class="n">processing</span> <span class="n">certain</span> <span class="n">input</span> <span class="n">events</span> <span class="n">that</span> <span class="n">were</span> <span class="n">delivered</span> <span class="n">to</span> <span class="n">it</span> <span class="n">over</span> <span class="mf">500.0</span><span class="n">ms</span> <span class="n">ago</span><span class="o">.</span>  <span class="n">Wait</span> <span class="n">queue</span> <span class="nl">length:</span> <span class="mi">6</span><span class="o">.</span>  <span class="n">Wait</span> <span class="n">queue</span> <span class="n">head</span> <span class="nl">age:</span> <span class="mf">5533.6</span><span class="n">ms</span><span class="o">.)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>2.1 AMS#dumpStackTraces方法</h4>

<p>这个方法主要是手机栈信息，然后把信息写入到制定的文件，全局的文件路径是<code>/data/anr/traces.txt</code>，我们看看他的具体实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * If a stack trace dump file is configured, dump process stack traces.</span>
</span><span class='line'><span class="cm"> * @param clearTraces causes the dump file to be erased prior to the new</span>
</span><span class='line'><span class="cm"> *    traces being written, if true; when false, the new traces will be</span>
</span><span class='line'><span class="cm"> *    appended to any existing file content.</span>
</span><span class='line'><span class="cm"> * @param firstPids of dalvik VM processes to dump stack traces for first</span>
</span><span class='line'><span class="cm"> * @param lastPids of dalvik VM processes to dump stack traces for last</span>
</span><span class='line'><span class="cm"> * @param nativePids optional list of native pids to dump stack crawls</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">File</span> <span class="nf">dumpStackTraces</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">clearTraces</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">firstPids</span><span class="o">,</span>
</span><span class='line'>        <span class="n">ProcessCpuTracker</span> <span class="n">processCpuTracker</span><span class="o">,</span> <span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">lastPids</span><span class="o">,</span>
</span><span class='line'>        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">nativePids</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">extraPids</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Measure CPU usage as soon as we&#39;re called in order to get a realistic sampling</span>
</span><span class='line'>    <span class="c1">// of the top users at the time of the request.</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">processCpuTracker</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">processCpuTracker</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">processCpuTracker</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// We&#39;ll take the stack crawls of just the top apps using CPU.</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">processCpuTracker</span><span class="o">.</span><span class="na">countWorkingStats</span><span class="o">();</span>
</span><span class='line'>        <span class="n">extraPids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span> <span class="o">&amp;&amp;</span> <span class="n">extraPids</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ProcessCpuTracker</span><span class="o">.</span><span class="na">Stats</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">processCpuTracker</span><span class="o">.</span><span class="na">getWorkingStats</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">lastPids</span><span class="o">.</span><span class="na">indexOfKey</span><span class="o">(</span><span class="n">stats</span><span class="o">.</span><span class="na">pid</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Collecting stacks for extra pid &quot;</span> <span class="o">+</span> <span class="n">stats</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">extraPids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">stats</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Skipping next CPU consuming process, not a java proc: &quot;</span>
</span><span class='line'>                        <span class="o">+</span> <span class="n">stats</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">useTombstonedForJavaTraces</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="n">File</span> <span class="n">tracesFile</span><span class="o">;</span>
</span><span class='line'>          <span class="c1">//判断系统是否配置了存放anr日志的目录，默认情况下是没有配置的,华为手机默认配置为：/data/anr</span>
</span><span class='line'>      <span class="c1">//可以使用反射，自己来测试这些值</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">String</span> <span class="n">tracesDirProp</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;dalvik.vm.stack-trace-dir&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">tracesDirProp</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// When dalvik.vm.stack-trace-dir is not set, we are using the &quot;old&quot; trace</span>
</span><span class='line'>        <span class="c1">// dumping scheme. All traces are written to a global trace file (usually</span>
</span><span class='line'>        <span class="c1">// &quot;/data/anr/traces.txt&quot;) so the code below must take care to unlink and recreate</span>
</span><span class='line'>        <span class="c1">// the file if requested.</span>
</span><span class='line'>        <span class="c1">//</span>
</span><span class='line'>        <span class="c1">// This mode of operation will be removed in the near future.</span>
</span><span class='line'>
</span><span class='line'>                  <span class="c1">//得到的是系统默认存放anr日志的路径，默认为/data/anr/trace.txt</span>
</span><span class='line'>          <span class="c1">//可以使用反射，自己来测试</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">globalTracesPath</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;dalvik.vm.stack-trace-file&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">globalTracesPath</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;dumpStackTraces: no trace path configured&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>                  <span class="c1">//创建文件</span>
</span><span class='line'>        <span class="n">tracesFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">globalTracesPath</span><span class="o">);</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">//是否清空原来的文件，默认anr情况下clearTraces为true，清空</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">clearTraces</span> <span class="o">&amp;&amp;</span> <span class="n">tracesFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">tracesFile</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">tracesFile</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
</span><span class='line'>            <span class="n">FileUtils</span><span class="o">.</span><span class="na">setPermissions</span><span class="o">(</span><span class="n">globalTracesPath</span><span class="o">,</span> <span class="mi">0666</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// -rw-rw-rw-</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Unable to prepare ANR traces file: &quot;</span> <span class="o">+</span> <span class="n">tracesFile</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">File</span> <span class="n">tracesDir</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">tracesDirProp</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// When dalvik.vm.stack-trace-dir is set, we use the &quot;new&quot; trace dumping scheme.</span>
</span><span class='line'>        <span class="c1">// Each set of ANR traces is written to a separate file and dumpstate will process</span>
</span><span class='line'>        <span class="c1">// all such files and add them to a captured bug report if they&#39;re recent enough.</span>
</span><span class='line'>        <span class="n">maybePruneOldTraces</span><span class="o">(</span><span class="n">tracesDir</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// NOTE: We should consider creating the file in native code atomically once we&#39;ve</span>
</span><span class='line'>        <span class="c1">// gotten rid of the old scheme of dumping and lot of the code that deals with paths</span>
</span><span class='line'>        <span class="c1">// can be removed.</span>
</span><span class='line'>        <span class="n">tracesFile</span> <span class="o">=</span> <span class="n">createAnrDumpFile</span><span class="o">(</span><span class="n">tracesDir</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">tracesFile</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">useTombstonedForJavaTraces</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dumpStackTraces</span><span class="o">(</span><span class="n">tracesFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span> <span class="n">firstPids</span><span class="o">,</span> <span class="n">nativePids</span><span class="o">,</span> <span class="n">extraPids</span><span class="o">,</span>
</span><span class='line'>            <span class="n">useTombstonedForJavaTraces</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">tracesFile</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果是系统配置了<code>dalvik.vm.stack-trace-dir</code>这个属性，则表示使用tombstone的方式来dump日志，那么这种方式下，创建文件的方式是不一样的，我们看<code>createAnrDumpFile</code>方法，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">File</span> <span class="nf">createAnrDumpFile</span><span class="o">(</span><span class="n">File</span> <span class="n">tracesDir</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">sAnrFileDateFormat</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">sAnrFileDateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd-HH-mm-ss-SSS&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">final</span> <span class="n">String</span> <span class="n">formattedDate</span> <span class="o">=</span> <span class="n">sAnrFileDateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nf">Date</span><span class="o">());</span>
</span><span class='line'>      <span class="c1">//tracesDir，模拟器没有配置，华为手机配置为/data/anr</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">File</span> <span class="n">anrFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">tracesDir</span><span class="o">,</span> <span class="s">&quot;anr_&quot;</span> <span class="o">+</span> <span class="n">formattedDate</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">anrFile</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">FileUtils</span><span class="o">.</span><span class="na">setPermissions</span><span class="o">(</span><span class="n">anrFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span> <span class="mi">0600</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// -rw-------</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">anrFile</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Unable to create ANR dump file: createNewFile failed&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Exception creating ANR dump file:&quot;</span><span class="o">,</span> <span class="n">ioe</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从上面可以看出，如果配置了<code>dalvik.vm.stack-trace-dir</code>，则存储anr栈信息的文件名称为变为了</p>

<p><strong>tracesDir+&ldquo;anr_&rdquo;+&ldquo;yyyy-MM-dd-HH-mm-ss-SSS&rdquo;</strong>这种命名风格，华为的手机默认就是这种。</p>

<p>进一步调用AMS的dumpStackTraces方法，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">dumpStackTraces</span><span class="o">(</span><span class="n">String</span> <span class="n">tracesFile</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">firstPids</span><span class="o">,</span>
</span><span class='line'>        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">nativePids</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">extraPids</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">useTombstonedForJavaTraces</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// We don&#39;t need any sort of inotify based monitoring when we&#39;re dumping traces via</span>
</span><span class='line'>    <span class="c1">// tombstoned. Data is piped to an &quot;intercept&quot; FD installed in tombstoned so we&#39;re in full</span>
</span><span class='line'>    <span class="c1">// control of all writes to the file in question.</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">DumpStackFileObserver</span> <span class="n">observer</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">useTombstonedForJavaTraces</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">observer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Use a FileObserver to detect when traces finish writing.</span>
</span><span class='line'>        <span class="c1">// The order of traces is considered important to maintain for legibility.</span>
</span><span class='line'>        <span class="n">observer</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DumpStackFileObserver</span><span class="o">(</span><span class="n">tracesFile</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//我们必须在20s内完成dump stacks的信息</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">remainingTime</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">//利用FileObserver来监听/anr/data/traces.txt目录</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">observer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">observer</span><span class="o">.</span><span class="na">startWatching</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// First collect all of the stacks of the most important pids.</span>
</span><span class='line'>          <span class="c1">//首先收集最重要pids的栈信息,一般就是直接导致anr的进程，开发中就是我们自己应用的进程</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">firstPids</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">firstPids</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Collecting stacks for pid &quot;</span>
</span><span class='line'>                        <span class="o">+</span> <span class="n">firstPids</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
</span><span class='line'>                <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeTaken</span><span class="o">;</span>
</span><span class='line'>                  <span class="c1">//是否使用tombstone来记录java的堆栈信息</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">useTombstonedForJavaTraces</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">timeTaken</span> <span class="o">=</span> <span class="n">dumpJavaTracesTombstoned</span><span class="o">(</span><span class="n">firstPids</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">tracesFile</span><span class="o">,</span> <span class="n">remainingTime</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">timeTaken</span> <span class="o">=</span> <span class="n">observer</span><span class="o">.</span><span class="na">dumpWithTimeout</span><span class="o">(</span><span class="n">firstPids</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">remainingTime</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">remainingTime</span> <span class="o">-=</span> <span class="n">timeTaken</span><span class="o">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">remainingTime</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Aborting stack trace dump (current firstPid=&quot;</span> <span class="o">+</span> <span class="n">firstPids</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>                        <span class="s">&quot;); deadline exceeded.&quot;</span><span class="o">);</span>
</span><span class='line'>                    <span class="k">return</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Done with pid &quot;</span> <span class="o">+</span> <span class="n">firstPids</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot; in &quot;</span> <span class="o">+</span> <span class="n">timeTaken</span> <span class="o">+</span> <span class="s">&quot;ms&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Next collect the stacks of the native pids</span>
</span><span class='line'>          <span class="c1">//如果20s时间还有剩余，那么继续收集那些native进程的堆栈信息</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">nativePids</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">pid</span> <span class="o">:</span> <span class="n">nativePids</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Collecting stacks for native pid &quot;</span> <span class="o">+</span> <span class="n">pid</span><span class="o">);</span>
</span><span class='line'>                <span class="kd">final</span> <span class="kt">long</span> <span class="n">nativeDumpTimeoutMs</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">NATIVE_DUMP_TIMEOUT_MS</span><span class="o">,</span> <span class="n">remainingTime</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="kd">final</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span><span class='line'>                <span class="n">Debug</span><span class="o">.</span><span class="na">dumpNativeBacktraceToFileTimeout</span><span class="o">(</span>
</span><span class='line'>                        <span class="n">pid</span><span class="o">,</span> <span class="n">tracesFile</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">nativeDumpTimeoutMs</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span>
</span><span class='line'>                <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeTaken</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">remainingTime</span> <span class="o">-=</span> <span class="n">timeTaken</span><span class="o">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">remainingTime</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Aborting stack trace dump (current native pid=&quot;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span>
</span><span class='line'>                        <span class="s">&quot;); deadline exceeded.&quot;</span><span class="o">);</span>
</span><span class='line'>                    <span class="k">return</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Done with native pid &quot;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s">&quot; in &quot;</span> <span class="o">+</span> <span class="n">timeTaken</span> <span class="o">+</span> <span class="s">&quot;ms&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//最后，如果20s的时间还有剩余，那么收集cpu tracker中所有的其他pid的栈信息</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">extraPids</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">pid</span> <span class="o">:</span> <span class="n">extraPids</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Collecting stacks for extra pid &quot;</span> <span class="o">+</span> <span class="n">pid</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeTaken</span><span class="o">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">useTombstonedForJavaTraces</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">timeTaken</span> <span class="o">=</span> <span class="n">dumpJavaTracesTombstoned</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">tracesFile</span><span class="o">,</span> <span class="n">remainingTime</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">timeTaken</span> <span class="o">=</span> <span class="n">observer</span><span class="o">.</span><span class="na">dumpWithTimeout</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">remainingTime</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">remainingTime</span> <span class="o">-=</span> <span class="n">timeTaken</span><span class="o">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">remainingTime</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Aborting stack trace dump (current extra pid=&quot;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span>
</span><span class='line'>                            <span class="s">&quot;); deadline exceeded.&quot;</span><span class="o">);</span>
</span><span class='line'>                    <span class="k">return</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_ANR</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Done with extra pid &quot;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s">&quot; in &quot;</span> <span class="o">+</span> <span class="n">timeTaken</span> <span class="o">+</span> <span class="s">&quot;ms&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">observer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">//停止监听文件夹</span>
</span><span class='line'>            <span class="n">observer</span><span class="o">.</span><span class="na">stopWatching</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里有两种不走来获取进程stack</p>

<p>&#8195;1. 使用DumpStackFileObserver的dumpWithTimeout方法来获取堆栈信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="kd">public</span> <span class="kt">long</span> <span class="nf">dumpWithTimeout</span><span class="o">(</span><span class="kt">int</span> <span class="n">pid</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">//发送一个SIGNAL_QUIT信号，开始获取堆栈信息</span>
</span><span class='line'>          <span class="c1">//等效于adb shell kill -3 pid</span>
</span><span class='line'>        <span class="n">sendSignal</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">SIGNAL_QUIT</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span><span class='line'>                  <span class="c1">//timeout传进来的值，最大的为20s，TRACE_DUMP_TIMEOUT_MS默认值为10s</span>
</span><span class='line'>          <span class="c1">//等待大概10s钟</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">long</span> <span class="n">waitTime</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="n">TRACE_DUMP_TIMEOUT_MS</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">wait</span><span class="o">(</span><span class="n">waitTime</span><span class="o">);</span> <span class="c1">// Wait for traces file to be closed.</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Slog</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// This avoids a corner case of passing a negative time to the native</span>
</span><span class='line'>        <span class="c1">// trace in case we&#39;ve already hit the overall timeout.</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeWaited</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">timeWaited</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">timeWaited</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>          <span class="c1">//public synchronized void onEvent(int event, String path) {</span>
</span><span class='line'>        <span class="c1">//   mClosed = true;</span>
</span><span class='line'>        <span class="c1">//   notify();</span>
</span><span class='line'>          <span class="c1">//}</span>
</span><span class='line'>                  <span class="c1">//mclosed值在监视的onEvent方法里置位true，然后条用notify方法,通知不用等待</span>
</span><span class='line'>          <span class="c1">//如果等待了timeWaited时间后，anr的traces.txt文件还没有生成，则开始尝试dump</span>
</span><span class='line'>          <span class="c1">//native stack的信息</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">mClosed</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Didn&#39;t see close of &quot;</span> <span class="o">+</span> <span class="n">mTracesPath</span> <span class="o">+</span> <span class="s">&quot; for pid &quot;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span>
</span><span class='line'>                   <span class="s">&quot;. Attempting native stack collection.&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">nativeDumpTimeoutMs</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">NATIVE_DUMP_TIMEOUT_MS</span><span class="o">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="n">timeWaited</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Debug</span><span class="o">.</span><span class="na">dumpNativeBacktraceToFileTimeout</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">mTracesPath</span><span class="o">,</span>
</span><span class='line'>                    <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">nativeDumpTimeoutMs</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mClosed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8195;2. 利用AMS的dumpJavaTracesTombstoned方法来获取日志</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Dump java traces for process {@code pid} to the specified file. If java trace dumping</span>
</span><span class='line'><span class="cm"> * fails, a native backtrace is attempted. Note that the timeout {@code timeoutMs} only applies</span>
</span><span class='line'><span class="cm"> * to the java section of the trace, a further {@code NATIVE_DUMP_TIMEOUT_MS} might be spent</span>
</span><span class='line'><span class="cm"> * attempting to obtain native traces in the case of a failure. Returns the total time spent</span>
</span><span class='line'><span class="cm"> * capturing traces.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">dumpJavaTracesTombstoned</span><span class="o">(</span><span class="kt">int</span> <span class="n">pid</span><span class="o">,</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMs</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeStart</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">Debug</span><span class="o">.</span><span class="na">dumpJavaBacktraceToFileTimeout</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">fileName</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">timeoutMs</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">)))</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Debug</span><span class="o">.</span><span class="na">dumpNativeBacktraceToFileTimeout</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">fileName</span><span class="o">,</span>
</span><span class='line'>                <span class="o">(</span><span class="n">NATIVE_DUMP_TIMEOUT_MS</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">-</span> <span class="n">timeStart</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的逻辑主要还是两部分：</p>

<p>&#8195;1. 使用Debug的dumpJavaBacktraceToFileTimeout方法来dump对应pid的栈信息，如果dump失败，则执行2步</p>

<p>&#8195;2. 在第一步失败后，尝试调用Debug的dumpNativeBacktraceToFileTimeout方法来dump信息，尝试的最大时间为2s</p>

<p>这个方法还是利用Debug类中的dumpNativeBacktraceToFileTimeout这个native方法去获取native stack的信息，并追加到我们的记录anr的日志文件后面，这个方法的具体定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Append the native stack traces of a given process to a specified file.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @param pid pid to dump.</span>
</span><span class='line'><span class="cm"> * @param file path of file to append dump to.</span>
</span><span class='line'><span class="cm"> * @param timeoutSecs time to wait in seconds, or 0 to wait forever.</span>
</span><span class='line'><span class="cm"> * @hide</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">dumpNativeBacktraceToFileTimeout</span><span class="o">(</span><span class="kt">int</span> <span class="n">pid</span><span class="o">,</span> <span class="n">String</span> <span class="n">file</span><span class="o">,</span>
</span><span class='line'>                                                              <span class="kt">int</span> <span class="n">timeoutSecs</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>dump栈信息总结</h4>

<p>在dump栈信息的时候，过程分为：</p>

<p>&#8195;1. 首先判断系统是否配置<code>dalvik.vm.stack-trace-dir</code>属性，如果没有配置，则利用FileObserver来监听全局默认的路径，也就是<code>/data/anr/traces.txt</code>，当发生anr时，会发送<strong>SIGNAL_QUIT</strong>信号，相当于执行了<code>adb shell kill -3 pid</code>，通知系统开始收集Java栈信息，然后写入到全局路径中。如果dump Java栈信息失败，则尝试通过Debug来dump native进程的栈信息，尝试的时间为2s。</p>

<p>&#8195;2. 如果系统配置了<code>dalvik.vm.stack-trace-dir</code>属性，则会标志位useTombstonedForJavaTraces为true，表示使用Debug.dumpJavaBacktraceToFileTimeout方法来dump Java堆栈的信息。</p>

<p>&#8195; 3. 如果上两个步骤完成后，20s钟时间还剩余，则开始dump 一些不是非常重要的native进程的堆栈信息</p>

<p>&#8195; 4. 如果上面三个步骤完后后，20s钟时间还剩余，则开始dump  cpu tracker中所有的其他pid的栈信息(更加的底层)。</p>

<h4>2.2 ProcessCpuTracker cpu信息的收集</h4>

<p>主要是使用<code>printCurrentState</code>方法来收集每个进程的cpu的使用情况。具体看<strong><code>printCurrentState</code></strong>方法实现</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="kd">final</span> <span class="kd">public</span> <span class="n">String</span> <span class="nf">printCurrentState</span><span class="o">(</span><span class="kt">long</span> <span class="n">now</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">SimpleDateFormat</span> <span class="n">sdf</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">buildWorkingProcs</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">StringWriter</span> <span class="n">sw</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StringWriter</span><span class="o">();</span>
</span><span class='line'>        <span class="n">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FastPrintWriter</span><span class="o">(</span><span class="n">sw</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">1024</span><span class="o">);</span>
</span><span class='line'>              <span class="c1">//信息的头部</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;CPU usage from &quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="c1">//判断是ANR前，还是ANR后</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">mLastSampleTime</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">now</span><span class="o">-</span><span class="n">mLastSampleTime</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;ms to &quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">now</span><span class="o">-</span><span class="n">mCurrentSampleTime</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;ms ago&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">mLastSampleTime</span><span class="o">-</span><span class="n">now</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;ms to &quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">mCurrentSampleTime</span><span class="o">-</span><span class="n">now</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;ms later&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; (&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">sdf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">mLastSampleWallTime</span><span class="o">)));</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; to &quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">sdf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">mCurrentSampleWallTime</span><span class="o">)));</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">long</span> <span class="n">sampleTime</span> <span class="o">=</span> <span class="n">mCurrentSampleTime</span> <span class="o">-</span> <span class="n">mLastSampleTime</span><span class="o">;</span>
</span><span class='line'>        <span class="kt">long</span> <span class="n">sampleRealTime</span> <span class="o">=</span> <span class="n">mCurrentSampleRealTime</span> <span class="o">-</span> <span class="n">mLastSampleRealTime</span><span class="o">;</span>
</span><span class='line'>        <span class="kt">long</span> <span class="n">percAwake</span> <span class="o">=</span> <span class="n">sampleRealTime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">((</span><span class="n">sampleTime</span><span class="o">*</span><span class="mi">100</span><span class="o">)</span> <span class="o">/</span> <span class="n">sampleRealTime</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">percAwake</span> <span class="o">!=</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; with &quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">percAwake</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;% awake&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">totalTime</span> <span class="o">=</span> <span class="n">mRelUserTime</span> <span class="o">+</span> <span class="n">mRelSystemTime</span> <span class="o">+</span> <span class="n">mRelIoWaitTime</span>
</span><span class='line'>                <span class="o">+</span> <span class="n">mRelIrqTime</span> <span class="o">+</span> <span class="n">mRelSoftIrqTime</span> <span class="o">+</span> <span class="n">mRelIdleTime</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;totalTime &quot;</span> <span class="o">+</span> <span class="n">totalTime</span> <span class="o">+</span> <span class="s">&quot; over sample time &quot;</span>
</span><span class='line'>                <span class="o">+</span> <span class="o">(</span><span class="n">mCurrentSampleTime</span><span class="o">-</span><span class="n">mLastSampleTime</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">mWorkingProcs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Stats</span> <span class="n">st</span> <span class="o">=</span> <span class="n">mWorkingProcs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>            <span class="n">printProcessCPU</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span> <span class="n">st</span><span class="o">.</span><span class="na">added</span> <span class="o">?</span> <span class="s">&quot; +&quot;</span> <span class="o">:</span> <span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">removed</span> <span class="o">?</span> <span class="s">&quot; -&quot;</span><span class="o">:</span> <span class="s">&quot;  &quot;</span><span class="o">),</span>
</span><span class='line'>                    <span class="n">st</span><span class="o">.</span><span class="na">pid</span><span class="o">,</span> <span class="n">st</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">st</span><span class="o">.</span><span class="na">rel_uptime</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">st</span><span class="o">.</span><span class="na">rel_utime</span><span class="o">,</span> <span class="n">st</span><span class="o">.</span><span class="na">rel_stime</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">st</span><span class="o">.</span><span class="na">rel_minfaults</span><span class="o">,</span> <span class="n">st</span><span class="o">.</span><span class="na">rel_majfaults</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(!</span><span class="n">st</span><span class="o">.</span><span class="na">removed</span> <span class="o">&amp;&amp;</span> <span class="n">st</span><span class="o">.</span><span class="na">workingThreads</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">M</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">workingThreads</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">M</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Stats</span> <span class="n">tst</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">workingThreads</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
</span><span class='line'>                  <span class="c1">//打印每个进程的信息</span>
</span><span class='line'>                    <span class="n">printProcessCPU</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span>
</span><span class='line'>                            <span class="n">tst</span><span class="o">.</span><span class="na">added</span> <span class="o">?</span> <span class="s">&quot;   +&quot;</span> <span class="o">:</span> <span class="o">(</span><span class="n">tst</span><span class="o">.</span><span class="na">removed</span> <span class="o">?</span> <span class="s">&quot;   -&quot;</span><span class="o">:</span> <span class="s">&quot;    &quot;</span><span class="o">),</span>
</span><span class='line'>                            <span class="n">tst</span><span class="o">.</span><span class="na">pid</span><span class="o">,</span> <span class="n">tst</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">st</span><span class="o">.</span><span class="na">rel_uptime</span><span class="o">,</span>
</span><span class='line'>                            <span class="n">tst</span><span class="o">.</span><span class="na">rel_utime</span><span class="o">,</span> <span class="n">tst</span><span class="o">.</span><span class="na">rel_stime</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>              <span class="c1">//答应total的信息，格式47% TOTAL: 31% user + 15% kernel + 0.2% softirq</span>
</span><span class='line'>        <span class="n">printProcessCPU</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;TOTAL&quot;</span><span class="o">,</span> <span class="n">totalTime</span><span class="o">,</span> <span class="n">mRelUserTime</span><span class="o">,</span> <span class="n">mRelSystemTime</span><span class="o">,</span>
</span><span class='line'>                <span class="n">mRelIoWaitTime</span><span class="o">,</span> <span class="n">mRelIrqTime</span><span class="o">,</span> <span class="n">mRelSoftIrqTime</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">sw</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">printProcessCPU</span><span class="o">(</span><span class="n">PrintWriter</span> <span class="n">pw</span><span class="o">,</span> <span class="n">String</span> <span class="n">prefix</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="o">,</span> <span class="n">String</span> <span class="n">label</span><span class="o">,</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">totalTime</span><span class="o">,</span> <span class="kt">int</span> <span class="n">user</span><span class="o">,</span> <span class="kt">int</span> <span class="n">system</span><span class="o">,</span> <span class="kt">int</span> <span class="n">iowait</span><span class="o">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="o">,</span> <span class="kt">int</span> <span class="n">softIrq</span><span class="o">,</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">minFaults</span><span class="o">,</span> <span class="kt">int</span> <span class="n">majFaults</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">prefix</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">totalTime</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="n">totalTime</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="n">printRatio</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span> <span class="n">user</span><span class="o">+</span><span class="n">system</span><span class="o">+</span><span class="n">iowait</span><span class="o">+</span><span class="n">irq</span><span class="o">+</span><span class="n">softIrq</span><span class="o">,</span> <span class="n">totalTime</span><span class="o">);</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;% &quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">pid</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">label</span><span class="o">);</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;: &quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">printRatio</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">totalTime</span><span class="o">);</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;% user + &quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">printRatio</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span> <span class="n">system</span><span class="o">,</span> <span class="n">totalTime</span><span class="o">);</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;% kernel&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">iowait</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; + &quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">printRatio</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span> <span class="n">iowait</span><span class="o">,</span> <span class="n">totalTime</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;% iowait&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; + &quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">printRatio</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span> <span class="n">irq</span><span class="o">,</span> <span class="n">totalTime</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;% irq&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>          <span class="c1">//https://www.kernel.org/doc/htmldocs/kernel-hacking/basics-softirqs.html</span>
</span><span class='line'>          <span class="c1">//softirq </span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">softIrq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; + &quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">printRatio</span><span class="o">(</span><span class="n">pw</span><span class="o">,</span> <span class="n">softIrq</span><span class="o">,</span> <span class="n">totalTime</span><span class="o">);</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;% softirq&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">minFaults</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">majFaults</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; / faults:&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">minFaults</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">minFaults</span><span class="o">);</span>
</span><span class='line'>                <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; minor&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">majFaults</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">majFaults</span><span class="o">);</span>
</span><span class='line'>                <span class="n">pw</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; major&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">pw</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法就是打印每个进程，使用cpu的情况，完整的格式如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">CPU</span> <span class="n">usage</span> <span class="n">from</span> <span class="mi">839843</span><span class="n">ms</span> <span class="n">to</span> <span class="mi">0</span><span class="n">ms</span> <span class="nf">ago</span> <span class="o">(</span><span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">18</span> <span class="mi">18</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mf">53.827</span> <span class="n">to</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">08</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">44.991</span><span class="o">):</span>
</span><span class='line'>      <span class="mf">4.5</span><span class="o">%</span> <span class="mi">1638</span><span class="o">/</span><span class="nl">system_server:</span> <span class="mi">3</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">1.4</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">22176</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">2.2</span><span class="o">%</span> <span class="mi">1387</span><span class="o">/</span><span class="nl">adbd:</span> <span class="mf">0.2</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mi">2</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">49043</span> <span class="n">minor</span>
</span><span class='line'>      <span class="mf">0.8</span><span class="o">%</span> <span class="mi">1401</span><span class="o">/</span><span class="n">android</span><span class="o">.</span><span class="na">hardware</span><span class="o">.</span><span class="na">graphics</span><span class="o">.</span><span class="na">composer</span><span class="err">@</span><span class="mf">2.1</span><span class="o">-</span><span class="nl">service:</span> <span class="mi">0</span><span class="o">%</span> <span class="n">user</span> <span class="o">+</span> <span class="mf">0.7</span><span class="o">%</span> <span class="n">kernel</span> <span class="o">/</span> <span class="nl">faults:</span> <span class="mi">18</span> <span class="n">minor</span>
</span><span class='line'>      <span class="o">......</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>注意这里有一个<strong>softirq</strong>的耗时的统计，那这个是什么呢？这个softirq是表示软中断的意思，主要是Linux 系统内核里面的程序，具体可以查看<a href="https://www.kernel.org/doc/htmldocs/kernel-hacking/basics-softirqs.html">https://www.kernel.org/doc/htmldocs/kernel-hacking/basics-softirqs.html</a></p></blockquote>

<p><a href="https://www.cnblogs.com/CoderTian/p/5980426.html"></a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Lapisy</span></span>

      




<time class='entry-date' datetime='2019-04-29T22:24:59+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>10:24 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/framework/'>framework</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2019/04/23/androidxi-tong-zhi-watchdogxue-xi-jie-xi/" title="Previous Post: Android系统之Watchdog学习解析">&laquo; Android系统之Watchdog学习解析</a>
      
      
        <a class="basic-alignment right" href="/blog/2019/04/30/androidxi-tong-gong-ju-zhi-systracejie-shao-he-shi-yong/" title="Next Post: Android系统工具之Systrace介绍和使用">Android系统工具之Systrace介绍和使用 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/02/21/androidzi-yuan-kuang-jia-zhu-ti-themehe-style/">Android资源框架-主题Theme和Style</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/24/202020-xie-xin-de-ji-hua/">2020一些新的计划</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/05/12/vs-codeshi-yong-zong-jie/">VisualStudio Code使用总结</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/30/androidxi-tong-gong-ju-zhi-systracejie-shao-he-shi-yong/">Android系统工具之Systrace介绍和使用</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/29/androidxi-tong-zhi-anrri-zhi-shou-ji-guo-cheng/">Android系统之ANR日志收集过程-Java层</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/23/androidxi-tong-zhi-watchdogxue-xi-jie-xi/">Android系统之Watchdog学习解析</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/21/androidzhi-wen-jian-shang-chuan-yuan-li/">Android之文件上传原理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/20/octopressbo-ke-da-jian-yu-pei-zhi/">Octopress博客搭建与配置</a>
      </li>
    
  </ul>
</section>
<section>
    <h1>Categories</h1>
      <ul id="category-list"><li><a href='/blog/categories/2020/'>2020 (1)</a></li><li><a href='/blog/categories/android/'>android (3)</a></li><li><a href='/blog/categories/framework/'>framework (4)</a></li><li><a href='/blog/categories/octopress/'>octopress (1)</a></li><li><a href='/blog/categories/system/'>system (1)</a></li><li><a href='/blog/categories/systrace/'>systrace (1)</a></li><li><a href='/blog/categories/visual-code/'>visual code (1)</a></li><li><a href='/blog/categories/gong-ju/'>工具 (1)</a></li><li><a href='/blog/categories/sheng-huo/'>生活 (1)</a></li><li><a href='/blog/categories/wang-luo-shang-chuan-yuan-li/'>网络上传原理 (1)</a></li></ul>
  </section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Lapisy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
