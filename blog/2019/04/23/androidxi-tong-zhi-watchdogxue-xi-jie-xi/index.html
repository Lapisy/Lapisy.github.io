
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Android系统之Watchdog学习解析 - Lapisy的博客</title>
  <meta name="author" content="Lapisy">

  
  <meta name="description" content="一：概述 Watchdog 顾名思义，看门狗，是一个很重要的机制，其目的是监测系统或者硬件的运行的情况，一旦出现锁死，死机的情况，能及时重启机器（取决于每种实现的设置策略），并收集dump crash日志. 一般情况下有硬件层的Watchdog，也有软件层的Watchdog， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.lapisy.com/blog/2019/04/23/androidxi-tong-zhi-watchdogxue-xi-jie-xi/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Lapisy的博客" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->
  <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> -->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lapisy的博客</a></h1>
  
    <h2>Learning and Thinking</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="laisy的博客邮箱" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.lapisy.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">归档</a></li>
  <!-- <li><a href="/about">关于</a></li> -->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Android系统之Watchdog学习解析</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-23T22:56:45+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2019</span></span> <span class='time'>10:56 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>一：概述</h3>

<p>Watchdog 顾名思义，看门狗，是一个很重要的机制，其目的是监测系统或者硬件的运行的情况，一旦出现锁死，死机的情况，能及时重启机器（取决于每种实现的设置策略），并收集dump crash日志.</p>

<p>一般情况下有硬件层的Watchdog，也有软件层的Watchdog，例如Linux内核watchdog。但是无论其实现怎么样，但其基本思路包括：</p>

<p>1.假定某一个对象的状态能表征系统运行是否健康（比如interrupt的次数，比如/dev/watchdog的时间戳）;</p>

<p>2.启动一个watchdog程序，定期（通过内部或者外部时钟触发）来观测这个对象，来判定系统是否健康，并采取相应动作。</p>

<h3>二：Android系统中的Watchdog机制</h3>

<p>Android设计了一个软件层面Watchdog，用于保护一些重要的系统服务，当出现故障时，通常会让Android系统重启。由于这种机制的存在，就经常会出现一些system_server进程被Watchdog杀掉而发生手机重启的问题。</p>

<p>所以在Android的Watchdog机制中，我需要弄明白几个问题：</p>

<p>1.Watchdog监视什么？</p>

<p>2.Watchdog如何监视的，也就是判断的条件？</p>

<p>3.Watchdog监视的条件出现问题时，会进行那些操作？</p>

<!--more-->


<h4>2.1 Watchdog初始化</h4>

<p>Android中的Watchdog是单例的线程，他在SystemServer初始化的时候启动，并初始化，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">traceBeginAndSlog</span><span class="o">(</span><span class="s">&quot;InitWatchdog&quot;</span><span class="o">);</span>
</span><span class='line'><span class="kd">final</span> <span class="n">Watchdog</span> <span class="n">watchdog</span> <span class="o">=</span> <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span><span class='line'><span class="n">watchdog</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">mActivityManagerService</span><span class="o">);</span>
</span><span class='line'><span class="n">traceEnd</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码的主要原理就是获取Watchdog对象，并调用他的<code>init</code>方法，初始化。我们来看Watchdog的构造函数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="nf">Watchdog</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">(</span><span class="s">&quot;watchdog&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">mMonitorChecker</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HandlerChecker</span><span class="o">(</span><span class="n">FgThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">(),</span>
</span><span class='line'>            <span class="s">&quot;foreground thread&quot;</span><span class="o">,</span> <span class="n">DEFAULT_TIMEOUT</span><span class="o">);</span>
</span><span class='line'>    <span class="n">mHandlerCheckers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mMonitorChecker</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// Add checker for main thread.  We only do a quick check since there</span>
</span><span class='line'>    <span class="c1">// can be UI running on the thread.</span>
</span><span class='line'>    <span class="n">mHandlerCheckers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">HandlerChecker</span><span class="o">(</span><span class="k">new</span> <span class="nf">Handler</span><span class="o">(</span><span class="n">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">()),</span>
</span><span class='line'>            <span class="s">&quot;main thread&quot;</span><span class="o">,</span> <span class="n">DEFAULT_TIMEOUT</span><span class="o">));</span>
</span><span class='line'>    <span class="c1">// Add checker for shared UI thread.</span>
</span><span class='line'>    <span class="n">mHandlerCheckers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">HandlerChecker</span><span class="o">(</span><span class="n">UiThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">(),</span>
</span><span class='line'>            <span class="s">&quot;ui thread&quot;</span><span class="o">,</span> <span class="n">DEFAULT_TIMEOUT</span><span class="o">));</span>
</span><span class='line'>    <span class="c1">// And also check IO thread.</span>
</span><span class='line'>    <span class="n">mHandlerCheckers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">HandlerChecker</span><span class="o">(</span><span class="n">IoThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">(),</span>
</span><span class='line'>            <span class="s">&quot;i/o thread&quot;</span><span class="o">,</span> <span class="n">DEFAULT_TIMEOUT</span><span class="o">));</span>
</span><span class='line'>    <span class="c1">// And the display thread.</span>
</span><span class='line'>    <span class="n">mHandlerCheckers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">HandlerChecker</span><span class="o">(</span><span class="n">DisplayThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">(),</span>
</span><span class='line'>            <span class="s">&quot;display thread&quot;</span><span class="o">,</span> <span class="n">DEFAULT_TIMEOUT</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Initialize monitor for Binder threads.</span>
</span><span class='line'>    <span class="n">addMonitor</span><span class="o">(</span><span class="k">new</span> <span class="nf">BinderThreadMonitor</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mOpenFdMonitor</span> <span class="o">=</span> <span class="n">OpenFdMonitor</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// See the notes on DEFAULT_TIMEOUT.</span>
</span><span class='line'>    <span class="k">assert</span> <span class="n">DB</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">DEFAULT_TIMEOUT</span> <span class="o">&gt;</span> <span class="n">ZygoteConnectionConstants</span><span class="o">.</span><span class="na">WRAPPED_PID_TIMEOUT_MILLIS</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从这个构造函数中可以看到：Watchdog里面创建了很多的HandlerChecker对象，来监视不同的对象，主要分为两大类：</p>

<ul>
<li>Monitor Checker：这个主要是监测那些实现了Monitor接口的对象，主要是监测锁相关的异常，如死锁</li>
<li>Looper Checker：这个主要监测对应线程中的Loop是否阻塞，从构造函数中，我们可以看到主要监测了IO线程，Main线程，AMS等类</li>
</ul>


<h4>2.2 添加Watchdog监视对象</h4>

<p>Watchdog提供了两种接口来添加监视对象，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">addMonitor</span><span class="o">(</span><span class="n">Monitor</span> <span class="n">monitor</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Monitors can&#39;t be added once the Watchdog is running&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">mMonitorChecker</span><span class="o">.</span><span class="na">addMonitor</span><span class="o">(</span><span class="n">monitor</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addThread</span><span class="o">(</span><span class="n">Handler</span> <span class="n">thread</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">addThread</span><span class="o">(</span><span class="n">thread</span><span class="o">,</span> <span class="n">DEFAULT_TIMEOUT</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">addThread</span><span class="o">(</span><span class="n">Handler</span> <span class="n">thread</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMillis</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Threads can&#39;t be added once the Watchdog is running&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">().</span><span class="na">getThread</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'>            <span class="n">mHandlerCheckers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">HandlerChecker</span><span class="o">(</span><span class="n">thread</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">timeoutMillis</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>1.一种是通过<code>addMonitor</code>方法来添加Monitor对象，主要是添加到mMonitorChecker中一个Monitor的集合中</p>

<p>2.一种是通过<code>addThread</code>方法来添加Looper是否阻塞，主要是添加到mHandlerCheckers这个列表中</p>

<p>不管通过哪种方式添加，都是构造出了一个HandlerChecker对象，这是一个实现了Runnable接口的类，这个后面再详细讲。</p>

<p>那么系统一共添加了那些监测对象了，通过搜索代码，我们可以知道系统一些重要的Servcice都添加了监视，比如常见的AMS,PMS,PowerManagerService等都添加对应的监听，如下面的ASM的构造函数中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addMonitor</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addThread</span><span class="o">(</span><span class="n">mHandler</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>2.3 Watchdog的启动和监测</h4>

<p>我们知道Watchdog是一个线程，那么他是在哪里启动的呢？他是在ActivityManagerService准备好之后的回调里面执行的，调用了start方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">......</span>
</span><span class='line'>                  <span class="n">traceBeginAndSlog</span><span class="o">(</span><span class="s">&quot;StartWatchdog&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="n">traceEnd</span><span class="o">();</span>
</span><span class='line'>          <span class="o">......</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>启动线程后，会执行Watchdog的run方法，我来看看他的run方法是怎么去监视和处理的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>  <span class="c1">//这里是一个死循环，不断的监测</span>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">HandlerChecker</span><span class="o">&gt;</span> <span class="n">blockedCheckers</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">String</span> <span class="n">subject</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">allowRestart</span><span class="o">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">debuggerWasConnected</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">//每次检查的间隔时间，默认是30s</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">CHECK_INTERVAL</span><span class="o">;</span>
</span><span class='line'>          <span class="c1">//开始遍历所有的HandlerChecker对象，开始检测Looper</span>
</span><span class='line'>          <span class="c1">//注释4</span>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">mHandlerCheckers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">HandlerChecker</span> <span class="n">hc</span> <span class="o">=</span> <span class="n">mHandlerCheckers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>                <span class="n">hc</span><span class="o">.</span><span class="na">scheduleCheckLocked</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">debuggerWasConnected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">debuggerWasConnected</span><span class="o">--;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// NOTE: We use uptimeMillis() here because we do not want to increment the time we</span>
</span><span class='line'>            <span class="c1">// wait while asleep. If the device is asleep then the thing that we are waiting</span>
</span><span class='line'>            <span class="c1">// to timeout on is asleep as well and won&#39;t have a chance to run, causing a false</span>
</span><span class='line'>            <span class="c1">// positive on when to kill things.</span>
</span><span class='line'>          <span class="c1">//这个地方就是暂停30s</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
</span><span class='line'>            <span class="k">while</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">Debug</span><span class="o">.</span><span class="na">isDebuggerConnected</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">debuggerWasConnected</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">wait</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">Debug</span><span class="o">.</span><span class="na">isDebuggerConnected</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">debuggerWasConnected</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="n">timeout</span> <span class="o">=</span> <span class="n">CHECK_INTERVAL</span> <span class="o">-</span> <span class="o">(</span><span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="kt">boolean</span> <span class="n">fdLimitTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">mOpenFdMonitor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">fdLimitTriggered</span> <span class="o">=</span> <span class="n">mOpenFdMonitor</span><span class="o">.</span><span class="na">monitor</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(!</span><span class="n">fdLimitTriggered</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">//注释1</span>
</span><span class='line'>                <span class="kd">final</span> <span class="kt">int</span> <span class="n">waitState</span> <span class="o">=</span> <span class="n">evaluateCheckerCompletionLocked</span><span class="o">();</span>
</span><span class='line'>              <span class="c1">//注释2</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">waitState</span> <span class="o">==</span> <span class="n">COMPLETED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// The monitors have returned; reset</span>
</span><span class='line'>                    <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>                    <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">waitState</span> <span class="o">==</span> <span class="n">WAITING</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="c1">// still waiting but within their configured intervals; back off and recheck</span>
</span><span class='line'>                    <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">waitState</span> <span class="o">==</span> <span class="n">WAITED_HALF</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="o">(!</span><span class="n">waitedHalf</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="c1">// We&#39;ve waited half the deadlock-detection interval.  Pull a stack</span>
</span><span class='line'>                        <span class="c1">// trace and wait another half.</span>
</span><span class='line'>                        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">pids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>
</span><span class='line'>                        <span class="n">pids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">());</span>
</span><span class='line'>                        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">dumpStackTraces</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">pids</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                            <span class="n">getInterestingNativePids</span><span class="o">());</span>
</span><span class='line'>                        <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                    <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="c1">//注释3</span>
</span><span class='line'>                <span class="n">blockedCheckers</span> <span class="o">=</span> <span class="n">getBlockedCheckersLocked</span><span class="o">();</span>
</span><span class='line'>                <span class="n">subject</span> <span class="o">=</span> <span class="n">describeCheckersLocked</span><span class="o">(</span><span class="n">blockedCheckers</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">blockedCheckers</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
</span><span class='line'>                <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;Open FD high water mark reached&quot;</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">allowRestart</span> <span class="o">=</span> <span class="n">mAllowRestart</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// If we got here, that means that the system is most likely hung.</span>
</span><span class='line'>        <span class="c1">// First collect stack traces from all threads of the system process.</span>
</span><span class='line'>        <span class="c1">// Then kill this process so that the system will restart.</span>
</span><span class='line'>      <span class="c1">//注释4</span>
</span><span class='line'>        <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">WATCHDOG</span><span class="o">,</span> <span class="n">subject</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">pids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span><span class='line'>        <span class="n">pids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">());</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mPhonePid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="n">pids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mPhonePid</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// Pass !waitedHalf so that just in case we somehow wind up here without having</span>
</span><span class='line'>        <span class="c1">// dumped the halfway stacks, we properly re-initialize the trace file.</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">File</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">dumpStackTraces</span><span class="o">(</span>
</span><span class='line'>                <span class="o">!</span><span class="n">waitedHalf</span><span class="o">,</span> <span class="n">pids</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">getInterestingNativePids</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Give some extra time to make sure the stack traces get written.</span>
</span><span class='line'>        <span class="c1">// The system&#39;s been hanging for a minute, another second or two won&#39;t hurt much.</span>
</span><span class='line'>        <span class="n">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Trigger the kernel to dump all blocked threads, and backtraces on all CPUs to the kernel log</span>
</span><span class='line'>        <span class="n">doSysRq</span><span class="o">(</span><span class="sc">&#39;w&#39;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">doSysRq</span><span class="o">(</span><span class="sc">&#39;l&#39;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Try to add the error to the dropbox, but assuming that the ActivityManager</span>
</span><span class='line'>        <span class="c1">// itself may be deadlocked.  (which has happened, causing this statement to</span>
</span><span class='line'>        <span class="c1">// deadlock and the watchdog as a whole to be ineffective)</span>
</span><span class='line'>        <span class="n">Thread</span> <span class="n">dropboxThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">&quot;watchdogWriteToDropbox&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">mActivity</span><span class="o">.</span><span class="na">addErrorToDropBox</span><span class="o">(</span>
</span><span class='line'>                            <span class="s">&quot;watchdog&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s">&quot;system_server&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                            <span class="n">subject</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">stack</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">};</span>
</span><span class='line'>        <span class="n">dropboxThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">dropboxThread</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>  <span class="c1">// wait up to 2 seconds for it to return.</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">IActivityController</span> <span class="n">controller</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">controller</span> <span class="o">=</span> <span class="n">mController</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">controller</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Reporting stuck state to activity controller&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Binder</span><span class="o">.</span><span class="na">setDumpDisabled</span><span class="o">(</span><span class="s">&quot;Service dumps disabled due to hung system process.&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="c1">// 1 = keep waiting, -1 = kill system</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="na">systemNotResponding</span><span class="o">(</span><span class="n">subject</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Activity controller requested to coninue to wait&quot;</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>                    <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Only kill the process if the debugger is not attached.</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">Debug</span><span class="o">.</span><span class="na">isDebuggerConnected</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">debuggerWasConnected</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">debuggerWasConnected</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Debugger connected: Watchdog is *not* killing the system process&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">debuggerWasConnected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Debugger was connected: Watchdog is *not* killing the system process&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">allowRestart</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Restart not allowed: Watchdog is *not* killing the system process&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;*** WATCHDOG KILLING SYSTEM PROCESS: &quot;</span> <span class="o">+</span> <span class="n">subject</span><span class="o">);</span>
</span><span class='line'>            <span class="n">WatchdogDiagnostics</span><span class="o">.</span><span class="na">diagnoseCheckers</span><span class="o">(</span><span class="n">blockedCheckers</span><span class="o">);</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;*** GOODBYE!&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">Process</span><span class="o">.</span><span class="na">killProcess</span><span class="o">(</span><span class="n">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">());</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是run的整个实现，我们一一来看看一些重点的代码：</p>

<p>&#8194; 1. 注释1：在上面等待了固定的时间后，会调用<code>evaluateCheckerCompletionLocked</code>方法去监测各个对象的状态</p>

<p>&#8194;2. 注释2：根据返回的状态，来决定是否继续往下走，还是重复检查，这里涉及三个状态</p>

<p>&#8195;<code>COMPLETED</code>：正常运行，没有阻塞，默认值为0</p>

<p>&#8195;<code>WAITING</code>：如果等待的时间小于最大等待时间的一半时，返回这个值，默认为1</p>

<p>&#8195;<code>WAITED_HALF</code>：如果等待的时间大于最大时间的一半，同时小于最大时间，则返回这个值，默认为2</p>

<p>&#8195;<code>OVERDUE</code>：超过最大的等待时间</p>

<p>具体的可以看<code>getCompletionStateLocked</code>方法对状态的一个判断：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCompletionStateLocked</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mCompleted</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">COMPLETED</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">latency</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">mStartTime</span><span class="o">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">latency</span> <span class="o">&lt;</span> <span class="n">mWaitMax</span><span class="o">/</span><span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">WAITING</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">latency</span> <span class="o">&lt;</span> <span class="n">mWaitMax</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">WAITED_HALF</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">OVERDUE</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8194;3. 注释3：得到具体的阻塞对象的一些信息</p>

<p>&#8194;4. 注释4：一开始会去调用所有HandlerChecker类的<code>scheduleCheckLocked</code>方法，表示开始去执行检查的代码，而这里的HandlerChecker这个类，是一个实现了Runnable接口的对象，我们先看<code>scheduleCheckLocked</code>方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">scheduleCheckLocked</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">//监测Looper对应的queue是否空心啊，如果是的话，直接返回，继续检查</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mMonitors</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">getLooper</span><span class="o">().</span><span class="na">getQueue</span><span class="o">().</span><span class="na">isPolling</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mCompleted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">mCompleted</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// we already have a check in flight, so no need</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mCompleted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>        <span class="n">mCurrentMonitor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="n">mStartTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mHandler</span><span class="o">.</span><span class="na">postAtFrontOfQueue</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法的主要功能是：</p>

<p>&#8194;1. 通过<code>mHandler.getLooper().getQueue().isPolling()</code>判断队列是否在轮询中，如果是，表示队列没有阻塞，mCompleted设置为true，直接返回</p>

<p>&#8194;2. 如果没有，则mCompleted设置为false，然后把当前这个Runnable对象通过<code>postAtFrontOfQueue</code>方法发送到队列头部中，等待执行，如果没有执行，那么mCompleted一直未false，则表示可能阻塞。</p>

<p>一旦这个Runnable对象执行，则会执行他的run方法，我们来看下HandlerChecker的run方法，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">mMonitors</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Watchdog</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mCurrentMonitor</span> <span class="o">=</span> <span class="n">mMonitors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">mCurrentMonitor</span><span class="o">.</span><span class="na">monitor</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Watchdog</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCompleted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="n">mCurrentMonitor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法主要的内容是：</p>

<p>1.调用每个Monitor的monitor方法，来检测锁的状态，其实这个一般实现很简单，如AMS的放这个方法实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/** In this method we try to acquire our lock to make sure that we have not deadlocked */</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">monitor</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>就是获取锁，如果锁阻塞，那么这个方法会阻塞，Watchdog就会检测到这个异常</p>

<p>2.把mCompleted赋值为true，表示没有问题，顺利执行完了</p>

<h4>2.4 监视对象异常后的操作</h4>

<p>这一块主要是关注Watchdong的run方法，里面有检测</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="o">......</span>
</span><span class='line'>        <span class="c1">//通过EventLog写入watchdog信息</span>
</span><span class='line'>        <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">WATCHDOG</span><span class="o">,</span> <span class="n">subject</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">pids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span><span class='line'>        <span class="n">pids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">());</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mPhonePid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="n">pids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mPhonePid</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// Pass !waitedHalf so that just in case we somehow wind up here without having</span>
</span><span class='line'>        <span class="c1">// dumped the halfway stacks, we properly re-initialize the trace file.</span>
</span><span class='line'>      <span class="c1">//开始调用ActivityManagerService dump栈信息</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">File</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">dumpStackTraces</span><span class="o">(</span>
</span><span class='line'>                <span class="o">!</span><span class="n">waitedHalf</span><span class="o">,</span> <span class="n">pids</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">getInterestingNativePids</span><span class="o">());</span>
</span><span class='line'>                  <span class="c1">//等待dump操作完成</span>
</span><span class='line'>        <span class="n">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
</span><span class='line'>                  
</span><span class='line'>      <span class="c1">//触发内核dump所有的阻塞的线程，backtrace日志</span>
</span><span class='line'>        <span class="n">doSysRq</span><span class="o">(</span><span class="sc">&#39;w&#39;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">doSysRq</span><span class="o">(</span><span class="sc">&#39;l&#39;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Try to add the error to the dropbox, but assuming that the ActivityManager</span>
</span><span class='line'>        <span class="c1">// itself may be deadlocked.  (which has happened, causing this statement to</span>
</span><span class='line'>        <span class="c1">// deadlock and the watchdog as a whole to be ineffective)</span>
</span><span class='line'>      <span class="c1">//尝试把错误信息保存到dropbox中</span>
</span><span class='line'>        <span class="n">Thread</span> <span class="n">dropboxThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">&quot;watchdogWriteToDropbox&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">mActivity</span><span class="o">.</span><span class="na">addErrorToDropBox</span><span class="o">(</span>
</span><span class='line'>                            <span class="s">&quot;watchdog&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s">&quot;system_server&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                            <span class="n">subject</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">stack</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">};</span>
</span><span class='line'>        <span class="n">dropboxThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">dropboxThread</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>  <span class="c1">// wait up to 2 seconds for it to return.</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">IActivityController</span> <span class="n">controller</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">controller</span> <span class="o">=</span> <span class="n">mController</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">controller</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Reporting stuck state to activity controller&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Binder</span><span class="o">.</span><span class="na">setDumpDisabled</span><span class="o">(</span><span class="s">&quot;Service dumps disabled due to hung system process.&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="c1">// 1 = keep waiting, -1 = kill system</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="na">systemNotResponding</span><span class="o">(</span><span class="n">subject</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Activity controller requested to coninue to wait&quot;</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>                    <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Only kill the process if the debugger is not attached.</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">Debug</span><span class="o">.</span><span class="na">isDebuggerConnected</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">debuggerWasConnected</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">debuggerWasConnected</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Debugger connected: Watchdog is *not* killing the system process&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">debuggerWasConnected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Debugger was connected: Watchdog is *not* killing the system process&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">allowRestart</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Restart not allowed: Watchdog is *not* killing the system process&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">//开始杀死进程，</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;*** WATCHDOG KILLING SYSTEM PROCESS: &quot;</span> <span class="o">+</span> <span class="n">subject</span><span class="o">);</span>
</span><span class='line'>            <span class="n">WatchdogDiagnostics</span><span class="o">.</span><span class="na">diagnoseCheckers</span><span class="o">(</span><span class="n">blockedCheckers</span><span class="o">);</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;*** GOODBYE!&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">Process</span><span class="o">.</span><span class="na">killProcess</span><span class="o">(</span><span class="n">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">());</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>发生死锁，异常后，主要的操作为：</p>

<p>&#8194;1. 通过EventLog写入watcndog的event先关信息</p>

<p>&#8194;2. 调用ActivityManagerService dump栈信息</p>

<p>&#8194;3. 触发内核dump所有的阻塞的线程，backtrace日志</p>

<p>&#8194;4. 尝试把错误信息保存到dropbox中</p>

<p>&#8194;5. 并检查activity controller连接的调试器是否可以处理这次watchdog无响应，如果activity controller不要求重启，那么就忽视这次超时，从头继续运行watchdog循环。</p>

<p>&#8194;6. 如果不是debug状态，杀死SystemServer并重启手机，</p>

<h3>三：总结</h3>

<p>整个Watchdog的监测过程如下：</p>

<p>&#8194;1. 在创建SystemServer进程后，创建Watchdog对象，初始化，主要是注册系统reboot的广播监听</p>

<p>&#8194;2. 在AMS准备好后，在器systemReady方法回调中，启动Watchdog线程</p>

<p>&#8194;3. 在一些需要被监听的service中，通过addMonitor和addThread的方法，添加到Watchdog监听中</p>

<p>&#8194;4. Watchdog利用一个死循环，每隔固定的时间（默认为30s）不断的监测对象，主要分为两种：一种是监测Looper队列是否阻塞，如果没有阻塞，则直接返回，继续下次监测。二是监测Monitor对象，并调用monitor方法，判断是否发生死锁。</p>

<p>&#8194;5. 如果发生了死锁或者looper阻塞，则记录下各种日志，并杀死SystemServer进程，重启系统</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Lapisy</span></span>

      




<time class='entry-date' datetime='2019-04-23T22:56:45+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2019</span></span> <span class='time'>10:56 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/framework/'>framework</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2019/04/21/androidzhi-wen-jian-shang-chuan-yuan-li/" title="Previous Post: Android之文件上传原理">&laquo; Android之文件上传原理</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/04/23/androidxi-tong-zhi-watchdogxue-xi-jie-xi/">Android系统之Watchdog学习解析</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/21/androidzhi-wen-jian-shang-chuan-yuan-li/">Android之文件上传原理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/20/octopressbo-ke-da-jian-yu-pei-zhi/">Octopress博客搭建与配置</a>
      </li>
    
  </ul>
</section>
<section>
    <h1>Categories</h1>
      <ul id="category-list"><li><a href='/blog/categories/android/'>android (2)</a></li><li><a href='/blog/categories/framework/'>framework (1)</a></li><li><a href='/blog/categories/octopress/'>octopress (1)</a></li><li><a href='/blog/categories/wang-luo-shang-chuan-yuan-li/'>网络上传原理 (1)</a></li></ul>
  </section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Lapisy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
